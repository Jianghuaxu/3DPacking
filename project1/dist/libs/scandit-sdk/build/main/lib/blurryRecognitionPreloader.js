"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.BlurryRecognitionPreloader=void 0;var tslib_1=require("tslib");var eventemitter3_1=require("eventemitter3");var __1=require("..");var barcode_1=require("./barcode");var browserHelper_1=require("./browserHelper");var dataCaptureLoader_1=require("./dataCaptureLoader");var logger_1=require("./logger");var dataCaptureWorker_1=require("./workers/dataCaptureWorker");var BlurryRecognitionPreloaderEventEmitter=function(e){(0,tslib_1.__extends)(a,e);function a(){return e!==null&&e.apply(this,arguments)||this}return a}(eventemitter3_1.EventEmitter);var BlurryRecognitionPreloader=function(){function e(a){this.eventEmitter=new eventemitter3_1.EventEmitter;this.queuedBlurryRecognitionSymbologies=Array.from(e.availableBlurryRecognitionSymbologies.values());this.readyBlurryRecognitionSymbologies=new Set;this.preload=a}e.create=function(a){return(0,tslib_1.__awaiter)(this,void 0,void 0,function(){var r,t;return(0,tslib_1.__generator)(this,function(o){if(a){r=browserHelper_1.BrowserHelper.userAgentInfo.getBrowser().name;if(r!=null&&r.includes("Edge")){t=new Worker(URL.createObjectURL(new Blob(["(".concat(e.workerIndexedDBSupportTestFunction.toString(),")()")],{type:"text/javascript"})));return[2,new Promise(function(a){t.onmessage=function(r){t.terminate();a(new e(r.data))}})]}}return[2,new e(a)]})})};e.workerIndexedDBSupportTestFunction=function(){try{indexedDB.deleteDatabase("scandit_indexeddb_support_test");postMessage(true)}catch(e){postMessage(false)}};e.prototype.prepareBlurryTables=function(){return(0,tslib_1.__awaiter)(this,void 0,void 0,function(){var a,r;return(0,tslib_1.__generator)(this,function(t){switch(t.label){case 0:a=true;if(!this.preload)return[3,4];t.label=1;case 1:t.trys.push([1,3,,4]);return[4,this.checkBlurryTablesAlreadyAvailable()];case 2:a=t.sent();return[3,4];case 3:r=t.sent();logger_1.Logger.log(logger_1.Logger.Level.ERROR,r);return[3,4];case 4:if(a){this.queuedBlurryRecognitionSymbologies=[];this.readyBlurryRecognitionSymbologies=new Set(e.availableBlurryRecognitionSymbologies);this.eventEmitter.emit("blurryTablesUpdate",new Set(this.readyBlurryRecognitionSymbologies))}else{this.dataCaptureWorker=new Worker(URL.createObjectURL(dataCaptureWorker_1.dataCaptureWorkerBlob));this.dataCaptureWorker.onmessage=this.dataCaptureWorkerOnMessage.bind(this);dataCaptureLoader_1.DataCaptureLoader.load(this.dataCaptureWorker,true,true)}return[2]}})})};e.prototype.on=function(a,r){if(a==="blurryTablesUpdate"){if(this.readyBlurryRecognitionSymbologies.size===e.availableBlurryRecognitionSymbologies.size){r(this.readyBlurryRecognitionSymbologies)}else{this.eventEmitter.on(a,r)}}};e.prototype.updateBlurryRecognitionPriority=function(e){var a=this.queuedBlurryRecognitionSymbologies.slice();this.getEnabledSymbologies(e).forEach(function(e){var r=a.indexOf(e);if(r!==-1){a.unshift(a.splice(r,1)[0])}});this.queuedBlurryRecognitionSymbologies=a};e.prototype.isBlurryRecognitionAvailable=function(e){var a=this;var r=this.getEnabledSymbologies(e);return r.every(function(e){return a.readyBlurryRecognitionSymbologies.has(e)})};e.prototype.getEnabledSymbologies=function(a){return Array.from(e.availableBlurryRecognitionSymbologies.values()).filter(function(e){return a.isSymbologyEnabled(e)})};e.prototype.createNextBlurryTableSymbology=function(){var e;do{e=this.queuedBlurryRecognitionSymbologies.shift()}while(e!=null&&this.readyBlurryRecognitionSymbologies.has(e));if(e!=null){this.dataCaptureWorker.postMessage({type:"create-blurry-table",symbology:e})}};e.prototype.checkBlurryTablesAlreadyAvailable=function(){return new Promise(function(a){var r=indexedDB.open(e.writableDataPath);function t(){var e;(e=r===null||r===void 0?void 0:r.result)===null||e===void 0?void 0:e.close();a(false)}r.onupgradeneeded=function(){try{r.result.createObjectStore(e.fsObjectStoreName)}catch(e){}};r.onsuccess=function(){try{var o=r.result.transaction(e.fsObjectStoreName,"readonly");o.onerror=t;var c=o.objectStore(e.fsObjectStoreName).getAllKeys();c.onsuccess=function(){r.result.close();if((__1.highEndBlurryRecognition?e.highEndBlurryTableFiles:e.defaultBlurryTableFiles).every(function(e){return c.result.indexOf(e)!==-1})){return a(true)}else{return a(false)}};c.onerror=t}catch(e){t.call({error:e})}};r.onblocked=r.onerror=t})};e.prototype.dataCaptureWorkerOnMessage=function(a){var r=this;var t=a.data;if(t[1]!=null){switch(t[0]){case"context-created":this.createNextBlurryTableSymbology();break;case"create-blurry-table-result":this.readyBlurryRecognitionSymbologies.add(t[1]);if([barcode_1.Barcode.Symbology.EAN8,barcode_1.Barcode.Symbology.EAN13,barcode_1.Barcode.Symbology.UPCA,barcode_1.Barcode.Symbology.UPCE].includes(t[1])){this.readyBlurryRecognitionSymbologies.add(barcode_1.Barcode.Symbology.EAN13);this.readyBlurryRecognitionSymbologies.add(barcode_1.Barcode.Symbology.EAN8);this.readyBlurryRecognitionSymbologies.add(barcode_1.Barcode.Symbology.UPCA);this.readyBlurryRecognitionSymbologies.add(barcode_1.Barcode.Symbology.UPCE)}else if([barcode_1.Barcode.Symbology.CODE32,barcode_1.Barcode.Symbology.CODE39].includes(t[1])){this.readyBlurryRecognitionSymbologies.add(barcode_1.Barcode.Symbology.CODE32);this.readyBlurryRecognitionSymbologies.add(barcode_1.Barcode.Symbology.CODE39)}this.eventEmitter.emit("blurryTablesUpdate",new Set(this.readyBlurryRecognitionSymbologies));if(this.readyBlurryRecognitionSymbologies.size===e.availableBlurryRecognitionSymbologies.size){setTimeout(function(){r.dataCaptureWorker.terminate()},250)}else{this.createNextBlurryTableSymbology()}break;default:break}}};e.writableDataPath="/scandit_sync_folder_preload";e.fsObjectStoreName="FILE_DATA";e.defaultBlurryTableFiles=["/606674e04e9da6f3ff049665e249a2d3.scandit","/05ccc70dd555fe1dd48784bd0cf8e386.scandit","/c5f9e9352415c38c40498e5e95dadfe7.scandit","/977fe759fdd7cdfe10730e7c6a313cf1.scandit","/1537c55cf10f0541c82353754f4c64fd.scandit","/975d994615bcffd9b2a73fa3a678eab0.scandit","/dd1689816469f85afcf8474667d8f03d.scandit","/8f244e6545292e588c1df97a086c6c1b.scandit","/a575dcaf6e5494a4fcc1ab4acde73ec8.scandit","/dabb5674b7672c4942b526b140087d72.scandit","/515813776005b3f7f83a2f1dda0c3512.scandit","/1803599e0a639ac73d4fa17406f626d0.scandit","/1c853515cb625cb5599ffbc55d49660b.scandit","/02f134be7444abe8670302d63154ee12.scandit","/f66d20444d640fb5696ad1fd84844da1.scandit","/cda0058badf2e2826f38e015b4bc2086.scandit","/a7f53b46cfafa92cda842f8e5552fe94.scandit","/520af862bc387cbcd123bf4f6c0a2309.scandit","/fe5dee8bc5034b58510f0525996d3fd1.scandit","/6fa9155af734f2c952b17414e455dd9d.scandit","/b43dfae194695c822dfccba33ff2c86d.scandit"].map(function(a){return"".concat(e.writableDataPath).concat(a)});e.highEndBlurryTableFiles=["/1874dc4934d21603e5d9a5ae43a778e4.scandit","/63c129cdcf76aea7d93d5be187fe2538.scandit","/115d22696b705b9981072313d6be73ea.scandit","/4608867660a119fc208c2e2d9cb324a5.scandit","/d17c176dc829d0963c15e161a80e5494.scandit","/5323ad9f4f68808ccbccf152360d858b.scandit","/280fc47c520d4da71bd7b46e800bf56d.scandit","/285e85aaef2ce3fc3e02bd3a122c88a3.scandit","/c511cd547c936a071b8d02714716e1ca.scandit","/4957f614000cb4e1c37230ddf6ae2695.scandit","/32b179628cb7fe9f7b9ec76f05f71843.scandit","/064d712f2a6804bf7eadcb4b03aac94b.scandit","/148896f408d127c37065bd889e097a48.scandit","/99f6c6df8988e4fa954ca95fc96d417a.scandit","/85502aef6aded3d4278bd979c10ad55e.scandit","/24b31e817a962593346bc5bedfecfd42.scandit","/13034b70bf6c595a3ae6df6d6ee1d6a4.scandit","/4cb12590b4dac0ac0f8724b8aa45b75d.scandit","/b3dfd3876ce0f8413c5069d87f8e8795.scandit","/40d900c40fd427d6cc7ea1418209a293.scandit","/feb5b253b7b4a9a210058f7cafa38461.scandit","/aabd7f1b722807e223293dfaf212be23.scandit","/2a9858ec9bba816cdfbdf1b14c8719a9.scandit","/d8011fc47cc6aec6b172aae4af4fdd9b.scandit","/e8747cf80b9ff066ca5026a8ca092b09.scandit","/5fdf50ec8f84271ea21dd77be8d44872.scandit","/661b785b69d6ca90e9d1ea8ab542b59f.scandit","/07fa32ccbca1132b1d4799883e98b39a.scandit","/5603271a54266a81ca40966e66e97265.scandit","/d623ba3aa0c43fb3fc1c7be7aa2c69d2.scandit","/bb770ea7325ee07808a318a236f2ec00.scandit","/c4ddab70bcfb9e88bd75786459211217.scandit","/9097adb842cd84073fd834d83520e3d3.scandit","/642f7fb3cf1b48a7391c2ac0358f2bc2.scandit","/a29f17de80be594245277fc418bf6a28.scandit","/5295187c71b6c414d89f41909a92d74e.scandit","/9dd44ec739d98429fc5fbdafb0127c43.scandit","/7bc6d7c115ffb99739447c56e1faa181.scandit","/2e84c1f83144a30ce5e3384766cd0918.scandit","/be65a2a8af180ba9461b4607de385afe.scandit","/8507e094c3e139c87cdba48291e5b888.scandit","/06c61f29f834fa28b36700587e777f89.scandit"].map(function(a){return"".concat(e.writableDataPath).concat(a)});e.availableBlurryRecognitionSymbologies=new Set([barcode_1.Barcode.Symbology.EAN13,barcode_1.Barcode.Symbology.EAN8,barcode_1.Barcode.Symbology.CODE32,barcode_1.Barcode.Symbology.CODE39,barcode_1.Barcode.Symbology.CODE128,barcode_1.Barcode.Symbology.CODE93,barcode_1.Barcode.Symbology.INTERLEAVED_2_OF_5,barcode_1.Barcode.Symbology.MSI_PLESSEY,barcode_1.Barcode.Symbology.CODABAR,barcode_1.Barcode.Symbology.UPCA,barcode_1.Barcode.Symbology.UPCE]);return e}();exports.BlurryRecognitionPreloader=BlurryRecognitionPreloader;