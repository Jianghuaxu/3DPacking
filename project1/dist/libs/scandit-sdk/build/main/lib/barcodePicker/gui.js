"use strict";var _a;Object.defineProperty(exports,"__esModule",{value:true});exports.GUI=void 0;var tslib_1=require("tslib");var resize_observer_1=require("@juggle/resize-observer");var ResizeObserver=(_a=window.ResizeObserver)!==null&&_a!==void 0?_a:resize_observer_1.ResizeObserver;var base64assets_1=require("../assets/base64assets");var browserHelper_1=require("../browserHelper");var camera_1=require("../camera");var cameraAccess_1=require("../cameraAccess");var imageSettings_1=require("../imageSettings");var logger_1=require("../logger");var singleImageModeSettings_1=require("../singleImageModeSettings");var barcodePicker_1=require("./barcodePicker");var GUI=function(){function e(t){var i=this;this.isVideoElementDetached=false;this.scanner=t.scanner;this.originElement=t.originElement;this.singleImageModeEnabled=t.singleImageModeEnabled;this.singleImageModeSettings=t.singleImageModeSettings;this.scanningPaused=t.scanningPaused;this.cameraUploadCallback=t.cameraUploadCallback;this.mirrorImageOverrides=new Map;this.cameraUploadInProgress=false;this.cameraSwitchInProgress=false;this.dataCaptureContextCreated=false;this.grandParentElement=document.createElement("div");this.grandParentElement.className=e.grandParentElementClassName;this.originElement.appendChild(this.grandParentElement);this.parentElement=document.createElement("div");this.parentElement.className=e.parentElementClassName;this.grandParentElement.appendChild(this.parentElement);this.videoElement=document.createElement("video");this.cameraSwitcherElement=document.createElement("img");this.torchTogglerElement=document.createElement("img");this.laserContainerElement=document.createElement("div");this.laserActiveImageElement=document.createElement("img");this.laserPausedImageElement=document.createElement("img");this.cameraRecoveryElement=document.createElement("div");this.viewfinderElement=document.createElement("div");var a=document.createElement("canvas");this.webGLContextLostListener=this.handleWebGLContextLost.bind(this);if(t.singleImageModeEnabled){this.context2d=a.getContext("2d");this.cameraUploadElement=document.createElement("div");this.cameraUploadLabelElement=document.createElement("label");this.cameraUploadInputElement=document.createElement("input");this.cameraUploadProgressElement=document.createElement("div");this.setupCameraUploadGuiAssets();this.guiStyle=barcodePicker_1.BarcodePicker.GuiStyle.NONE}else{this.setupContext(a);this.setupVideoElement();this.setupCameraSwitcher();this.setupTorchToggler();this.setupCameraRecovery(t.cameraRecoveryText);this.setupFullGuiAssets();this.setGuiStyle(t.guiStyle);this.setVideoFit(t.videoFit);this.setLaserArea(t.laserArea);this.setViewfinderArea(t.viewfinderArea);this.visibilityListener=this.checkAndRecoverPlayback.bind(this);document.addEventListener("visibilitychange",this.visibilityListener);this.newScanSettingsListener=this.handleNewScanSettings.bind(this);this.scanner.on("newScanSettings",this.newScanSettingsListener);this.handleNewScanSettings();this.videoPauseListener=this.handleVideoPause.bind(this);this.videoElement.addEventListener("pause",this.videoPauseListener);this.videoResizeListener=this.handleVideoResize.bind(this);this.videoElement.addEventListener("resize",this.videoResizeListener)}if(t.hideLogo){this.contextCreatedShowLogoListener=this.showScanditLogo.bind(this,t.hideLogo);this.scanner.on("contextCreated",this.contextCreatedShowLogoListener)}else{this.showScanditLogo(t.hideLogo)}this.contextCreatedActivateGUIListener=this.activateGUI.bind(this);this.scanner.on("contextCreated",this.contextCreatedActivateGUIListener);this.resize();this.resizeObserver=new ResizeObserver(function(){i.resize()});this.resizeObserver.observe(this.originElement);this.setVisible(t.visible)}e.prototype.destroy=function(){var t,i,a,s;if(this.visibilityListener!=null){document.removeEventListener("visibilitychange",this.visibilityListener)}if(this.newScanSettingsListener!=null){this.scanner.removeListener("newScanSettings",this.newScanSettingsListener)}if(this.videoPauseListener!=null){this.videoElement.removeEventListener("pause",this.videoPauseListener)}if(this.videoResizeListener!=null){this.videoElement.removeEventListener("resize",this.videoResizeListener)}if(this.contextCreatedShowLogoListener!=null){this.scanner.removeListener("contextCreated",this.contextCreatedShowLogoListener)}if(this.contextCreatedActivateGUIListener!=null){this.scanner.removeListener("contextCreated",this.contextCreatedActivateGUIListener)}this.resizeObserver.disconnect();this.grandParentElement.remove();this.videoElement.remove();(i=(t=this.contextWebGL)===null||t===void 0?void 0:t.canvas)===null||i===void 0?void 0:i.removeEventListener("webglcontextlost",this.webGLContextLostListener);(s=(a=this.contextWebGL)===null||a===void 0?void 0:a.getExtension("WEBGL_lose_context"))===null||s===void 0?void 0:s.loseContext();this.contextWebGL=undefined;this.context2d=undefined;this.originElement.classList.remove(e.hiddenClassName)};e.prototype.setCameraManager=function(e){this.cameraManager=e};e.prototype.pauseScanning=function(){this.scanningPaused=true;this.laserActiveImageElement.classList.add(e.hiddenOpacityClassName);this.laserPausedImageElement.classList.remove(e.hiddenOpacityClassName);this.viewfinderElement.classList.add(e.pausedClassName)};e.prototype.resumeScanning=function(){this.scanningPaused=false;if(this.dataCaptureContextCreated){this.laserPausedImageElement.classList.add(e.hiddenOpacityClassName);this.laserActiveImageElement.classList.remove(e.hiddenOpacityClassName);this.viewfinderElement.classList.remove(e.pausedClassName)}};e.prototype.isVisible=function(){return this.visible};e.prototype.setVisible=function(t){this.visible=t;if(t){this.originElement.classList.remove(e.hiddenClassName);if(this.guiStyle===barcodePicker_1.BarcodePicker.GuiStyle.LASER){this.laserActiveImageElement.classList.remove(e.flashColorClassName)}else if(this.guiStyle===barcodePicker_1.BarcodePicker.GuiStyle.VIEWFINDER){this.viewfinderElement.classList.remove(e.flashWhiteClassName)}}else{this.originElement.classList.add(e.hiddenClassName)}};e.prototype.isMirrorImageEnabled=function(){var e,t;if(((e=this.cameraManager)===null||e===void 0?void 0:e.selectedCamera)!=null&&((t=this.cameraManager)===null||t===void 0?void 0:t.activeCamera)!=null){var i=this.mirrorImageOverrides.get(this.cameraManager.activeCamera);return i!==null&&i!==void 0?i:this.cameraManager.activeCamera.cameraType===camera_1.Camera.Type.FRONT}else{return false}};e.prototype.setMirrorImageEnabled=function(t,i){var a;if(((a=this.cameraManager)===null||a===void 0?void 0:a.selectedCamera)!=null){if(t){this.videoElement.classList.add(e.mirroredClassName)}else{this.videoElement.classList.remove(e.mirroredClassName)}if(i){this.mirrorImageOverrides.set(this.cameraManager.selectedCamera,t)}}};e.prototype.setGuiStyle=function(t){if(this.singleImageModeEnabled){return}switch(t){case barcodePicker_1.BarcodePicker.GuiStyle.LASER:this.guiStyle=t;this.laserContainerElement.classList.remove(e.hiddenClassName);this.viewfinderElement.classList.add(e.hiddenClassName);break;case barcodePicker_1.BarcodePicker.GuiStyle.VIEWFINDER:this.guiStyle=t;this.laserContainerElement.classList.add(e.hiddenClassName);this.viewfinderElement.classList.remove(e.hiddenClassName);break;case barcodePicker_1.BarcodePicker.GuiStyle.NONE:default:this.guiStyle=barcodePicker_1.BarcodePicker.GuiStyle.NONE;this.laserContainerElement.classList.add(e.hiddenClassName);this.viewfinderElement.classList.add(e.hiddenClassName);break}};e.prototype.setLaserArea=function(e){this.customLaserArea=e;if(e==null){e=this.scanner.getScanSettings().getSearchArea()}var t=.025;var i=1-t*2;this.laserContainerElement.style.left="".concat((t+e.x*i)*100,"%");this.laserContainerElement.style.width="".concat(e.width*i*100,"%");this.laserContainerElement.style.top="".concat((t+e.y*i)*100,"%");this.laserContainerElement.style.height="".concat(e.height*i*100,"%")};e.prototype.setViewfinderArea=function(e){this.customViewfinderArea=e;if(e==null){e=this.scanner.getScanSettings().getSearchArea()}var t=.025;var i=1-t*2;this.viewfinderElement.style.left="".concat((t+e.x*i)*100,"%");this.viewfinderElement.style.width="".concat(e.width*i*100,"%");this.viewfinderElement.style.top="".concat((t+e.y*i)*100,"%");this.viewfinderElement.style.height="".concat(e.height*i*100,"%")};e.prototype.setVideoFit=function(e){if(this.singleImageModeEnabled){return}this.videoFit=e;if(e===barcodePicker_1.BarcodePicker.ObjectFit.COVER){this.videoElement.style.objectFit="cover";this.videoElement.dataset.objectFit="cover"}else{this.videoElement.style.objectFit="contain";this.videoElement.dataset.objectFit="contain";this.scanner.applyScanSettings(this.scanner.getScanSettings().setBaseSearchArea({x:0,y:0,width:1,height:1}))}this.resize()};e.prototype.reassignOriginElement=function(t){if(!this.visible){this.originElement.classList.remove(e.hiddenClassName);t.classList.add(e.hiddenClassName)}t.appendChild(this.grandParentElement);this.checkAndRecoverPlayback().catch(function(){});this.resize();this.resizeObserver.disconnect();this.resizeObserver.observe(t);this.originElement=t};e.prototype.flashGUI=function(){if(this.guiStyle===barcodePicker_1.BarcodePicker.GuiStyle.LASER){this.flashLaser()}else if(this.guiStyle===barcodePicker_1.BarcodePicker.GuiStyle.VIEWFINDER){this.flashViewfinder()}};e.prototype.getImageData=function(e){function t(e,t){return e.readyState===4&&e.videoWidth>2&&e.videoHeight>2&&t.canvas.width>2&&t.canvas.height>2}if(this.singleImageModeEnabled&&this.context2d!=null){return new Uint8Array(this.context2d.getImageData(0,0,this.context2d.canvas.width,this.context2d.canvas.height).data.buffer)}if(!this.singleImageModeEnabled){if(this.contextWebGL!=null){if(!t(this.videoElement,this.contextWebGL)||this.contextWebGL.drawingBufferWidth<=2||this.contextWebGL.drawingBufferHeight<=2){return}var i=this.contextWebGL.drawingBufferWidth*this.contextWebGL.drawingBufferHeight*4;if(e==null||e.byteLength===0||e.byteLength!==i){e=new Uint8Array(i)}this.contextWebGL.texImage2D(this.contextWebGL.TEXTURE_2D,0,this.contextWebGL.RGBA,this.contextWebGL.RGBA,this.contextWebGL.UNSIGNED_BYTE,this.videoElement);this.contextWebGL.readPixels(0,0,this.contextWebGL.drawingBufferWidth,this.contextWebGL.drawingBufferHeight,this.contextWebGL.RGBA,this.contextWebGL.UNSIGNED_BYTE,e);if(e[3]!==255){logger_1.Logger.log(logger_1.Logger.Level.WARN,"Detected incorrect GPU accelerated WebGL image processing, switching to canvas mode");this.contextWebGL=undefined;this.setupContext(document.createElement("canvas"),true);this.handleVideoResize();return this.getImageData(e)}return e}if(this.context2d!=null){if(!t(this.videoElement,this.context2d)){return}this.context2d.drawImage(this.videoElement,0,0);return new Uint8Array(this.context2d.getImageData(0,0,this.context2d.canvas.width,this.context2d.canvas.height).data.buffer)}}return};e.prototype.getVideoCurrentTime=function(){return this.videoElement.currentTime};e.prototype.setCameraSwitcherVisible=function(t){if(t){this.cameraSwitcherElement.classList.remove(e.hiddenClassName)}else{this.cameraSwitcherElement.classList.add(e.hiddenClassName)}};e.prototype.isCameraRecoveryVisible=function(){return!this.cameraRecoveryElement.classList.contains(e.hiddenClassName)};e.prototype.setCameraRecoveryVisible=function(t){if(t){this.cameraRecoveryElement.classList.remove(e.hiddenClassName)}else{this.cameraRecoveryElement.classList.add(e.hiddenClassName)}};e.prototype.setTorchTogglerVisible=function(t){if(t){this.torchTogglerElement.classList.remove(e.hiddenClassName)}else{this.torchTogglerElement.classList.add(e.hiddenClassName)}};e.prototype.playVideo=function(){var e=this.videoElement.play();e===null||e===void 0?void 0:e.catch(function(){})};e.prototype.setVideoVisible=function(e){this.videoElement.style.visibility=e?"visible":"hidden"};e.prototype.setCameraType=function(e){var t;(t=this.cameraUploadInputElement)===null||t===void 0?void 0:t.setAttribute("capture",e===camera_1.Camera.Type.FRONT?"user":"environment")};e.prototype.setCameraUploadGuiBusyScanning=function(t){if(t){this.cameraUploadProgressElement.classList.remove(e.flashInsetClassName);this.cameraUploadElement.classList.add(e.opacityPulseClassName)}else{this.cameraUploadProgressElement.classList.add(e.flashInsetClassName);this.cameraUploadElement.classList.remove(e.opacityPulseClassName)}};e.prototype.setupContext=function(e,t){if(t===void 0){t=false}if(t){this.context2d=e.getContext("2d");return}var i=e.getContext("webgl",{alpha:false,antialias:false});if(i==null){i=e.getContext("experimental-webgl",{alpha:false,antialias:false})}if(i!=null){this.setupWebGL(i);e.addEventListener("webglcontextlost",this.webGLContextLostListener)}else{this.context2d=e.getContext("2d")}};e.prototype.setupWebGL=function(e){var t=e.createTexture();e.bindTexture(e.TEXTURE_2D,t);var i=e.createFramebuffer();e.bindFramebuffer(e.FRAMEBUFFER,i);e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,t,0);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST);e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST);this.contextWebGL=e};e.prototype.setupVideoElement=function(){this.videoElement.setAttribute("autoplay","autoplay");this.videoElement.setAttribute("playsinline","true");this.videoElement.setAttribute("muted","muted");this.videoElement.className=e.videoElementClassName;this.parentElement.appendChild(this.videoElement)};e.prototype.setupCameraUploadGuiAssets=function(){var t=this;var i,a;var s=browserHelper_1.BrowserHelper.userAgentInfo.getDevice().type;var n=s==="mobile"||s==="tablet"?singleImageModeSettings_1.SingleImageModeSettings.defaultMobile:singleImageModeSettings_1.SingleImageModeSettings.defaultDesktop;this.cameraUploadElement.className=e.cameraUploadElementClassName;Object.assign(this.cameraUploadElement.style,n.containerStyle,this.singleImageModeSettings.containerStyle);this.parentElement.appendChild(this.cameraUploadElement);var r=(i=this.singleImageModeSettings.informationElement)!==null&&i!==void 0?i:n.informationElement;Object.assign(r.style,n.informationStyle,this.singleImageModeSettings.informationStyle);this.cameraUploadElement.appendChild(r);this.cameraUploadInputElement.type="file";this.cameraUploadInputElement.accept="image/*";this.cameraUploadInputElement.addEventListener("change",this.cameraUploadFile.bind(this));var l=function(e){if(t.scanningPaused||t.cameraUploadInProgress){e.preventDefault()}};this.cameraUploadInputElement.addEventListener("click",l);this.cameraUploadInputElement.addEventListener("keydown",l);this.cameraUploadLabelElement.appendChild(this.cameraUploadInputElement);var o=(a=this.singleImageModeSettings.buttonElement)!==null&&a!==void 0?a:n.buttonElement;[this.cameraUploadProgressElement.style,o.style].forEach(function(e){Object.assign(e,n.buttonStyle,t.singleImageModeSettings.buttonStyle)});o.style.maxWidth="100px";o.style.maxHeight="100px";this.cameraUploadLabelElement.appendChild(o);this.cameraUploadProgressElement.classList.add("radial-progress");this.cameraUploadLabelElement.appendChild(this.cameraUploadProgressElement);this.cameraUploadElement.appendChild(this.cameraUploadLabelElement)};e.prototype.setupFullGuiAssets=function(){this.laserActiveImageElement.src=base64assets_1.laserActiveImage;this.laserContainerElement.appendChild(this.laserActiveImageElement);this.laserPausedImageElement.src=base64assets_1.laserPausedImage;this.laserContainerElement.appendChild(this.laserPausedImageElement);this.laserContainerElement.className=e.laserContainerElementClassName;this.parentElement.appendChild(this.laserContainerElement);this.viewfinderElement.className=e.viewfinderElementClassName;this.parentElement.appendChild(this.viewfinderElement);this.laserActiveImageElement.classList.add(e.hiddenOpacityClassName);this.laserPausedImageElement.classList.remove(e.hiddenOpacityClassName);this.viewfinderElement.classList.add(e.pausedClassName)};e.prototype.flashLaser=function(){this.laserActiveImageElement.classList.remove(e.flashColorClassName);this.laserActiveImageElement.offsetHeight;this.laserActiveImageElement.classList.add(e.flashColorClassName)};e.prototype.flashViewfinder=function(){this.viewfinderElement.classList.remove(e.flashWhiteClassName);this.viewfinderElement.offsetHeight;this.viewfinderElement.classList.add(e.flashWhiteClassName)};e.prototype.resize=function(){this.parentElement.style.maxWidth="";this.parentElement.style.maxHeight="";var e=this.originElement.clientWidth;var t=this.originElement.clientHeight;if(e===0||t===0){if(!this.singleImageModeEnabled){this.handleVideoDisplay(true)}return}if(this.singleImageModeEnabled){this.resizeCameraUpload(e,t)}else{this.resizeVideo(e,t);this.handleVideoDisplay(false)}};e.prototype.resizeCameraUpload=function(e,t){this.cameraUploadLabelElement.style.transform="scale(".concat(Math.min(1,e/300,t/300),")")};e.prototype.resizeVideo=function(e,t){if(this.videoElement.videoWidth<=2||this.videoElement.videoHeight<=2){return}var i=this.videoElement.videoWidth/this.videoElement.videoHeight;if(this.videoFit===barcodePicker_1.BarcodePicker.ObjectFit.COVER){var a=1;var s=1;if(i<e/t){s=Math.min(1,t/(e/i))}else{a=Math.min(1,e/(t*i))}this.scanner.applyScanSettings(this.scanner.getScanSettings().setBaseSearchArea({x:(1-a)/2,y:(1-s)/2,width:a,height:s}));return}if(i>e/t){t=e/i}else{e=t*i}this.parentElement.style.maxWidth="".concat(Math.ceil(e),"px");this.parentElement.style.maxHeight="".concat(Math.ceil(t),"px");window.objectFitPolyfill(this.videoElement)};e.prototype.checkAndRecoverPlayback=function(){var e,t,i;return(0,tslib_1.__awaiter)(this,void 0,void 0,function(){var a,s;return(0,tslib_1.__generator)(this,function(n){switch(n.label){case 0:a=this.videoElement.srcObject;if(!(document.visibilityState==="visible"&&((e=this.cameraManager)===null||e===void 0?void 0:e.activeCamera)!=null&&((t=this.videoElement)===null||t===void 0?void 0:t.srcObject)!=null))return[3,6];if(!(!a.active||((i=a.getVideoTracks()[0])===null||i===void 0?void 0:i.muted)!==false))return[3,5];n.label=1;case 1:n.trys.push([1,3,,4]);logger_1.Logger.log(logger_1.Logger.Level.DEBUG,'Detected visibility change ("visible") event with inactive video source, try to reinitialize camera');return[4,this.cameraManager.reinitializeCamera()];case 2:n.sent();return[3,4];case 3:s=n.sent();return[3,4];case 4:return[3,6];case 5:logger_1.Logger.log(logger_1.Logger.Level.DEBUG,'Detected visibility change ("visible") event with active video source, replay video');this.playVideo();n.label=6;case 6:return[2]}})})};e.prototype.updateCameraUploadProgress=function(e){this.cameraUploadProgressElement.setAttribute("data-progress",e)};e.prototype.cameraUploadImageLoad=function(e){return(0,tslib_1.__awaiter)(this,void 0,void 0,function(){var t,i,a;return(0,tslib_1.__generator)(this,function(s){switch(s.label){case 0:this.updateCameraUploadProgress("100");a=1440;if(e.naturalWidth<=a&&e.naturalHeight<=a){t=e.naturalWidth;i=e.naturalHeight}else{if(e.naturalWidth>e.naturalHeight){t=a;i=Math.round(e.naturalHeight/e.naturalWidth*a)}else{t=Math.round(e.naturalWidth/e.naturalHeight*a);i=a}}return[4,this.cameraUploadFileProcess(e,t,i)];case 1:s.sent();return[2]}})})};e.prototype.cameraUploadFileProcess=function(e,t,i){return(0,tslib_1.__awaiter)(this,void 0,void 0,function(){return(0,tslib_1.__generator)(this,function(a){switch(a.label){case 0:if(this.context2d!=null){this.context2d.canvas.width=t;this.context2d.canvas.height=i;this.context2d.drawImage(e,0,0,t,i);this.scanner.applyImageSettings({width:t,height:i,format:imageSettings_1.ImageSettings.Format.RGBA_8U})}this.setCameraUploadGuiBusyScanning(true);return[4,this.cameraUploadCallback()];case 1:a.sent();this.setCameraUploadGuiBusyScanning(false);this.cameraUploadInProgress=false;return[2]}})})};e.prototype.cameraUploadFile=function(){var e=this;var t=this.cameraUploadInputElement.files;if(t!=null&&t.length!==0){this.cameraUploadInProgress=true;var i=new Image;var a=new FileReader;a.onload=function(){e.cameraUploadInputElement.value="";if(a.result!=null){i.onload=e.cameraUploadImageLoad.bind(e,i);i.onprogress=function(t){if(t.lengthComputable){var i=Math.round(t.loaded/t.total*20)*5;if(i<=100){e.updateCameraUploadProgress(i.toString())}}};i.onerror=function(){e.cameraUploadInProgress=false;logger_1.Logger.log(logger_1.Logger.Level.WARN,"Could not load image from selected file")};i.src=a.result}};a.onerror=function(){var t;e.cameraUploadInProgress=false;logger_1.Logger.log(logger_1.Logger.Level.WARN,"Error while reading the file: ".concat((t=a.error)===null||t===void 0?void 0:t.toString()))};this.updateCameraUploadProgress("0");a.readAsDataURL(t[0])}};e.prototype.cameraSwitcherListener=function(e){return(0,tslib_1.__awaiter)(this,void 0,void 0,function(){var t,i,a,s,n,r;return(0,tslib_1.__generator)(this,function(l){switch(l.label){case 0:if(!(!this.cameraSwitchInProgress&&this.cameraManager!=null))return[3,12];t=this.cameraManager;e.preventDefault();l.label=1;case 1:l.trys.push([1,11,,12]);return[4,cameraAccess_1.CameraAccess.getCameras()];case 2:i=l.sent();if(t.activeCamera==null){return[2]}if(i.length<=1){this.setCameraSwitcherVisible(false);return[2]}this.cameraSwitchInProgress=true;a=i.indexOf(t.activeCamera);s=(a+1)%i.length;l.label=3;case 3:if(!(s!==a))return[3,10];l.label=4;case 4:l.trys.push([4,6,,9]);return[4,t.initializeCameraWithSettings(i[s],t.activeCameraSettings)];case 5:l.sent();return[3,9];case 6:n=l.sent();logger_1.Logger.log(logger_1.Logger.Level.WARN,"Couldn't access camera:",i[s],n);s=(s+1)%i.length;if(!(s===a))return[3,8];this.setCameraSwitcherVisible(false);return[4,t.initializeCameraWithSettings(i[s],t.activeCameraSettings)];case 7:l.sent();l.label=8;case 8:return[3,3];case 9:return[3,10];case 10:this.cameraSwitchInProgress=false;return[3,12];case 11:r=l.sent();logger_1.Logger.log(logger_1.Logger.Level.ERROR,r);this.cameraSwitchInProgress=false;return[3,12];case 12:return[2]}})})};e.prototype.cameraRecoveryListener=function(e){var t;return(0,tslib_1.__awaiter)(this,void 0,void 0,function(){return(0,tslib_1.__generator)(this,function(i){switch(i.label){case 0:e.preventDefault();if(!(this.cameraManager!=null))return[3,2];this.cameraManager.activeCamera=this.cameraManager.selectedCamera;return[4,(t=this.cameraManager)===null||t===void 0?void 0:t.reinitializeCamera()];case 1:i.sent();i.label=2;case 2:return[2]}})})};e.prototype.setupCameraSwitcher=function(){var t=this;this.cameraSwitcherElement.src=base64assets_1.switchCameraImage;this.cameraSwitcherElement.className=e.cameraSwitcherElementClassName;this.cameraSwitcherElement.classList.add(e.hiddenClassName);this.parentElement.appendChild(this.cameraSwitcherElement);["touchstart","mousedown"].forEach(function(e){t.cameraSwitcherElement.addEventListener(e,t.cameraSwitcherListener.bind(t))})};e.prototype.setupCameraRecovery=function(t){var i=this;this.cameraRecoveryElement.textContent=t;this.cameraRecoveryElement.className=e.cameraRecoveryElementClassName;this.cameraRecoveryElement.classList.add(e.hiddenClassName);this.parentElement.appendChild(this.cameraRecoveryElement);["touchstart","mousedown"].forEach(function(e){i.cameraRecoveryElement.addEventListener(e,i.cameraRecoveryListener.bind(i))})};e.prototype.setupTorchToggler=function(){var t=this;this.torchTogglerElement.src=base64assets_1.toggleTorchImage;this.torchTogglerElement.className=e.torchTogglerElementClassName;this.torchTogglerElement.classList.add(e.hiddenClassName);this.parentElement.appendChild(this.torchTogglerElement);["touchstart","mousedown"].forEach(function(e){t.torchTogglerElement.addEventListener(e,function(e){return(0,tslib_1.__awaiter)(t,void 0,void 0,function(){return(0,tslib_1.__generator)(this,function(t){switch(t.label){case 0:if(!(this.cameraManager!=null))return[3,2];e.preventDefault();return[4,this.cameraManager.toggleTorch()];case 1:t.sent();t.label=2;case 2:return[2]}})})})})};e.prototype.showScanditLogo=function(t,i){if(t&&(i===null||i===void 0?void 0:i.hiddenScanditLogoAllowed)===true){return}var a=document.createElement("img");a.src=base64assets_1.scanditLogoImage;a.className=e.scanditLogoImageElementClassName;this.parentElement.appendChild(a)};e.prototype.activateGUI=function(){this.dataCaptureContextCreated=true;if(!this.scanningPaused){this.resumeScanning()}};e.prototype.handleNewScanSettings=function(){if(this.customLaserArea==null){this.setLaserArea()}if(this.customViewfinderArea==null){this.setViewfinderArea()}};e.prototype.handleVideoDisplay=function(e){if(e&&!this.isVideoElementDetached){this.videoElement.width=this.videoElement.height=0;this.videoElement.style.opacity="0";document.body.appendChild(this.videoElement);this.isVideoElementDetached=true}else if(!e&&this.isVideoElementDetached){this.parentElement.insertAdjacentElement("afterbegin",this.videoElement);this.isVideoElementDetached=false;this.videoElement.removeAttribute("width");this.videoElement.removeAttribute("height");this.videoElement.style.removeProperty("opacity");this.resize()}};e.prototype.handleVideoPause=function(){this.playVideo()};e.prototype.handleVideoResize=function(){this.resize();if(this.videoElement.videoWidth<=2||this.videoElement.videoHeight<=2){return}if(this.contextWebGL!=null){if(this.contextWebGL.canvas.width===this.videoElement.videoWidth&&this.contextWebGL.canvas.height===this.videoElement.videoHeight){return}this.contextWebGL.canvas.width=this.videoElement.videoWidth;this.contextWebGL.canvas.height=this.videoElement.videoHeight;this.contextWebGL.viewport(0,0,this.contextWebGL.drawingBufferWidth,this.contextWebGL.drawingBufferHeight);this.scanner.applyImageSettings({width:this.contextWebGL.drawingBufferWidth,height:this.contextWebGL.drawingBufferHeight,format:imageSettings_1.ImageSettings.Format.RGBA_8U})}else if(this.context2d!=null){if(this.context2d.canvas.width===this.videoElement.videoWidth&&this.context2d.canvas.height===this.videoElement.videoHeight){return}this.context2d.canvas.width=this.videoElement.videoWidth;this.context2d.canvas.height=this.videoElement.videoHeight;this.scanner.applyImageSettings({width:this.videoElement.videoWidth,height:this.videoElement.videoHeight,format:imageSettings_1.ImageSettings.Format.RGBA_8U})}};e.prototype.handleWebGLContextLost=function(){logger_1.Logger.log(logger_1.Logger.Level.WARN,"WebGL context has been lost, restoring...");this.contextWebGL=undefined;this.setupContext(document.createElement("canvas"));this.handleVideoResize();logger_1.Logger.log(logger_1.Logger.Level.WARN,"WebGL context restored")};e.grandParentElementClassName="scandit scandit-container";e.parentElementClassName="scandit scandit-barcode-picker";e.hiddenClassName="scandit-hidden";e.hiddenOpacityClassName="scandit-hidden-opacity";e.videoElementClassName="scandit-video";e.scanditLogoImageElementClassName="scandit-logo";e.laserContainerElementClassName="scandit-laser";e.viewfinderElementClassName="scandit-viewfinder";e.cameraSwitcherElementClassName="scandit-camera-switcher";e.cameraRecoveryElementClassName="scandit-camera-recovery";e.torchTogglerElementClassName="scandit-torch-toggle";e.cameraUploadElementClassName="scandit-camera-upload";e.flashColorClassName="scandit-flash-color";e.flashWhiteClassName="scandit-flash-white";e.flashInsetClassName="scandit-flash-inset";e.opacityPulseClassName="scandit-opacity-pulse";e.mirroredClassName="mirrored";e.pausedClassName="paused";return e}();exports.GUI=GUI;