"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.BarcodePicker=void 0;var tslib_1=require("tslib");var eventemitter3_1=require("eventemitter3");var howler_core_min_js_1=require("howler/dist/howler.core.min.js");var base64assets_1=require("../assets/base64assets");var index_1=require("../../index");var browserHelper_1=require("../browserHelper");var camera_1=require("../camera");var customError_1=require("../customError");var logger_1=require("../logger");var scanner_1=require("../scanner");var scanResult_1=require("../scanResult");var scanSettings_1=require("../scanSettings");var singleImageModeSettings_1=require("../singleImageModeSettings");var unsupportedBrowserError_1=require("../unsupportedBrowserError");var cameraManager_1=require("./cameraManager");var dummyCameraManager_1=require("./dummyCameraManager");var gui_1=require("./gui");var BarcodePickerEventEmitter=function(e){(0,tslib_1.__extends)(t,e);function t(){return e!==null&&e.apply(this,arguments)||this}return t}(eventemitter3_1.EventEmitter);
/**
 * A barcode picker element used to get and show camera input and perform scanning operations.
 *
 * The barcode picker will automatically fit and scale inside the given *originElement*.
 *
 * Each barcode picker internally contains a [[Scanner]] object with its own WebWorker thread running a
 * separate copy of the external Scandit Data Capture library. To optimize loading times and performance it's
 * recommended to reuse the same picker and to already create the picker in advance (hidden) and just
 * display it when needed whenever possible.
 *
 * As the loading of the external Scandit Data Capture library can take some time, the picker always starts inactive
 * (but showing GUI and video) and then activates, if not paused, as soon as the library is ready to scan.
 * The [[on]] method targeting the [[ready]] event can be used to set up a listener function to be called when the
 * library is loaded. The picker will be ready to start scanning when the library is fully loaded.
 *
 * By default the external Scandit Data Capture library is preloaded in order to reduce the initialization time as much
 * as possible.
 *
 * The picker can also operate in Single Image Mode: letting the user click/tap to take a single image to be scanned
 * via the camera (mobile) or a file select dialog (desktop). This is provided automatically as fallback by
 * default when the OS/browser only supports part of the needed features and cannot provide direct access to the camera
 * for video streaming and continuous scanning, or can also be forced on/off. This behaviour can be set up on creation
 * via the *singleImageModeSettings* option. Note that in this mode some of the functions provided by the picker will
 * have no effect.
 *
 * By default an alert is shown if an internal error during scanning is encountered which prevents the scanning
 * procedure from continuing when running on a local IP address. As this uses the built-in [[scanError]] event
 * functionality, if unwanted it can be disabled by calling [[removeAllListeners]] on the BarcodePicker
 * instance (right after creation).
 *
 * In accordance with our license terms, the Scandit logo displayed in the bottom right corner of the barcode picker
 * must be displayed and cannot be hidden by any method. Workarounds are not allowed.
 */var BarcodePicker=function(){function e(e,t){var r=t.visible,n=t.singleImageModeEnabled,i=t.singleImageModeSettings,a=t.playSoundOnScan,s=t.vibrateOnScan,o=t.scanningPaused,c=t.guiStyle,u=t.videoFit,l=t.cameraRecoveryText,g=t.laserArea,h=t.viewfinderArea,m=t.scanner,d=t.scanSettings,p=t.cameraType,v=t.targetScanningFPS,f=t.hideLogo;var b,S,y,_;this.isReadyToWork=false;this.destroyed=false;this.scanningPaused=o;howler_core_min_js_1.Howler.autoSuspend=false;this.beepSound=new howler_core_min_js_1.Howl({src:base64assets_1.beepSound});this.vibrateFunction=(y=(S=(b=navigator.vibrate)!==null&&b!==void 0?b:navigator.webkitVibrate)!==null&&S!==void 0?S:navigator.mozVibrate)!==null&&y!==void 0?y:navigator.msVibrate;this.eventEmitter=new eventemitter3_1.EventEmitter;this.setPlaySoundOnScanEnabled(a);this.setVibrateOnScanEnabled(s);this.setTargetScanningFPS(v);this.scanner=(_=m===null||m===void 0?void 0:m.applyScanSettings(d))!==null&&_!==void 0?_:new scanner_1.Scanner({scanSettings:d});this.scannerReadyEventListener=this.handleScannerReady.bind(this);this.scanner.on("ready",this.scannerReadyEventListener);this.gui=new gui_1.GUI({scanner:this.scanner,originElement:e,singleImageModeEnabled:n,singleImageModeSettings:i,scanningPaused:o,visible:r,guiStyle:c,videoFit:u,hideLogo:f,cameraRecoveryText:l,laserArea:g,viewfinderArea:h,cameraUploadCallback:this.processVideoFrame.bind(this,true)});if(n){this.cameraManager=new dummyCameraManager_1.DummyCameraManager(this.scanner,this.triggerCameraAccessError.bind(this),this.gui);this.gui.setCameraType(p)}else{this.cameraManager=new cameraManager_1.CameraManager(this.scanner,this.triggerCameraAccessError.bind(this),this.gui);this.scheduleVideoProcessing()}this.gui.setCameraManager(this.cameraManager)}e.ready=function(){};e.submitFrame=function(e){};e.processFrame=function(e){};e.scan=function(e){};e.scanError=function(e){};e.cameraAccessError=function(e){};e.create=function(t,r){var n;var i=r===void 0?{}:r,a=i.visible,s=a===void 0?true:a,o=i.singleImageModeSettings,c=o===void 0?{}:o,u=i.playSoundOnScan,l=u===void 0?false:u,g=i.vibrateOnScan,h=g===void 0?false:g,m=i.scanningPaused,d=m===void 0?false:m,p=i.guiStyle,v=p===void 0?e.GuiStyle.LASER:p,f=i.videoFit,b=f===void 0?e.ObjectFit.CONTAIN:f,S=i.cameraRecoveryText,y=S===void 0?"Tap/click to resume scanning":S,_=i.laserArea,E=i.viewfinderArea,w=i.scanner,T=i.scanSettings,M=T===void 0?new scanSettings_1.ScanSettings:T,P=i.enableCameraSwitcher,C=P===void 0?true:P,I=i.enableTorchToggle,A=I===void 0?true:I,F=i.enableTapToFocus,O=F===void 0?true:F,V=i.enablePinchToZoom,L=V===void 0?true:V,R=i.accessCamera,x=R===void 0?true:R,B=i.camera,D=i.cameraType,k=D===void 0?camera_1.Camera.Type.BACK:D,q=i.cameraSettings,H=i.targetScanningFPS,N=H===void 0?30:H,j=i.hideLogo,G=j===void 0?false:j;return(0,tslib_1.__awaiter)(this,void 0,void 0,function(){var r,i,a,o,u,g,m;return(0,tslib_1.__generator)(this,function(p){switch(p.label){case 0:r=browserHelper_1.BrowserHelper.userAgentInfo.getDevice().type;i=r==="mobile"||r==="tablet";a=(n=i?c.mobile:c.desktop)!==null&&n!==void 0?n:{};o=a.usageStrategy===singleImageModeSettings_1.SingleImageModeSettings.UsageStrategy.NEVER;u=a.usageStrategy===singleImageModeSettings_1.SingleImageModeSettings.UsageStrategy.ALWAYS;g=browserHelper_1.BrowserHelper.checkBrowserCompatibility();if(!g.scannerSupport||o&&!g.fullSupport){throw new unsupportedBrowserError_1.UnsupportedBrowserError(g)}if(!g.fullSupport&&!u){logger_1.Logger.log(logger_1.Logger.Level.INFO,"BarcodePicker's Single Image Mode is being used as fallback as the OS/browser combination doesn't "+"support camera video stream scanning (https://caniuse.com/#feat=stream). "+'You can configure this behaviour via the "singleImageModeSettings" option.',g)}if(index_1.configurePhase!=="done"){throw new customError_1.CustomError({name:"LibraryNotConfiguredError",message:index_1.configurePhase==="started"?"The library has not completed its configuration yet, please call 'configure' and wait for the returned\n              promise's resolution":"The library was not configured, 'configure' must be called with valid parameters before instantiating\n              the BarcodePicker"})}if(!browserHelper_1.BrowserHelper.isValidHTMLElement(t)){throw new customError_1.CustomError({name:"NoOriginElementError",message:"A valid origin HTML element must be given"})}m=new e(t,{visible:s,singleImageModeEnabled:g.fullSupport?u:true,singleImageModeSettings:a,playSoundOnScan:l,vibrateOnScan:h,scanningPaused:d,guiStyle:v,videoFit:b,cameraRecoveryText:y,laserArea:_,viewfinderArea:E,scanner:w,scanSettings:M,cameraType:k,targetScanningFPS:N,hideLogo:G});m.cameraManager.setInteractionOptions(C,A,O,L);m.cameraManager.setInitialCameraType(k);m.cameraManager.setSelectedCamera(B);m.cameraManager.setSelectedCameraSettings(q);m.cameraAccess=x;m.on("scanError",function(e){if(["localhost","127.0.0.1",""].includes(window.location.hostname)){alert(e)}});if(!x)return[3,2];return[4,m.cameraManager.setupCameras()];case 1:p.sent();p.label=2;case 2:return[2,m]}})})};e.prototype.destroy=function(e){if(e===void 0){e=true}this.pauseScanning(true);this.scanner.removeListener("ready",this.scannerReadyEventListener);this.destroyed=true;if(e){this.scanner.destroy()}this.gui.destroy();this.eventEmitter.removeAllListeners()};e.prototype.applyScanSettings=function(e){this.scanner.applyScanSettings(e);return this};e.prototype.isScanningPaused=function(){return this.scanningPaused};e.prototype.pauseScanning=function(e){if(e===void 0){e=false}this.scanningPaused=true;if(e){this.cameraManager.stopStream().catch(function(){})}if(this.scanner.isReady()){this.gui.pauseScanning()}return this};e.prototype.resumeScanning=function(){return(0,tslib_1.__awaiter)(this,void 0,void 0,function(){return(0,tslib_1.__generator)(this,function(e){switch(e.label){case 0:this.scanningPaused=false;if(this.scanner.isReady()){this.gui.resumeScanning()}if(!(this.cameraAccess&&this.getActiveCamera()==null))return[3,2];return[4,this.cameraManager.setupCameras()];case 1:e.sent();e.label=2;case 2:return[2,this]}})})};e.prototype.getActiveCamera=function(){return this.cameraManager.activeCamera};e.prototype.setActiveCamera=function(e,t){return(0,tslib_1.__awaiter)(this,void 0,void 0,function(){return(0,tslib_1.__generator)(this,function(r){switch(r.label){case 0:if(!(e==null||!this.cameraAccess))return[3,3];this.cameraManager.setSelectedCamera(e);this.cameraManager.setSelectedCameraSettings(t);if(!this.cameraAccess)return[3,2];return[4,this.cameraManager.setupCameras()];case 1:r.sent();r.label=2;case 2:return[3,5];case 3:return[4,this.cameraManager.initializeCameraWithSettings(e,t)];case 4:r.sent();r.label=5;case 5:return[2,this]}})})};e.prototype.setCameraType=function(e){return(0,tslib_1.__awaiter)(this,void 0,void 0,function(){return(0,tslib_1.__generator)(this,function(t){switch(t.label){case 0:this.gui.setCameraType(e);if(!this.cameraAccess)return[3,2];return[4,this.cameraManager.setCameraType(e)];case 1:t.sent();return[3,3];case 2:this.cameraManager.setInitialCameraType(e);t.label=3;case 3:return[2,this]}})})};e.prototype.applyCameraSettings=function(e){return(0,tslib_1.__awaiter)(this,void 0,void 0,function(){return(0,tslib_1.__generator)(this,function(t){switch(t.label){case 0:if(!!this.cameraAccess)return[3,1];this.cameraManager.setSelectedCameraSettings(e);return[3,3];case 1:return[4,this.cameraManager.applyCameraSettings(e)];case 2:t.sent();t.label=3;case 3:return[2,this]}})})};e.prototype.isVisible=function(){return this.gui.isVisible()};e.prototype.setVisible=function(e){this.gui.setVisible(e);return this};e.prototype.isMirrorImageEnabled=function(){return this.gui.isMirrorImageEnabled()};e.prototype.setMirrorImageEnabled=function(e){this.gui.setMirrorImageEnabled(e,true);return this};e.prototype.isPlaySoundOnScanEnabled=function(){return this.playSoundOnScan};e.prototype.setPlaySoundOnScanEnabled=function(e){this.playSoundOnScan=e;return this};e.prototype.isVibrateOnScanEnabled=function(){return this.vibrateOnScan};e.prototype.setVibrateOnScanEnabled=function(e){this.vibrateOnScan=e;return this};e.prototype.isCameraSwitcherEnabled=function(){return this.cameraManager.isCameraSwitcherEnabled()};e.prototype.setCameraSwitcherEnabled=function(e){this.cameraManager.setCameraSwitcherEnabled(e).catch(function(){});return this};e.prototype.isTorchToggleEnabled=function(){return this.cameraManager.isTorchToggleEnabled()};e.prototype.setTorchToggleEnabled=function(e){this.cameraManager.setTorchToggleEnabled(e);return this};e.prototype.isTapToFocusEnabled=function(){return this.cameraManager.isTapToFocusEnabled()};e.prototype.setTapToFocusEnabled=function(e){this.cameraManager.setTapToFocusEnabled(e);return this};e.prototype.isPinchToZoomEnabled=function(){return this.cameraManager.isPinchToZoomEnabled()};e.prototype.setPinchToZoomEnabled=function(e){this.cameraManager.setPinchToZoomEnabled(e);return this};e.prototype.setTorchEnabled=function(e){return(0,tslib_1.__awaiter)(this,void 0,void 0,function(){return(0,tslib_1.__generator)(this,function(t){switch(t.label){case 0:return[4,this.cameraManager.setTorchEnabled(e)];case 1:t.sent();return[2,this]}})})};e.prototype.setZoom=function(e){return(0,tslib_1.__awaiter)(this,void 0,void 0,function(){return(0,tslib_1.__generator)(this,function(t){switch(t.label){case 0:return[4,this.cameraManager.setZoom(e)];case 1:t.sent();return[2,this]}})})};e.prototype.isReady=function(){return this.isReadyToWork};e.prototype.on=function(e,t,r){if(r===void 0){r=false}if(e==="ready"){if(this.isReadyToWork){t()}else{this.eventEmitter.once(e,t,this)}}else{if(r===true){this.eventEmitter.once(e,t,this)}else{this.eventEmitter.on(e,t,this)}}return this};e.prototype.removeListener=function(e,t){this.eventEmitter.removeListener(e,t);return this};e.prototype.removeAllListeners=function(e){this.eventEmitter.removeAllListeners(e);return this};e.prototype.addListener=function(e,t,r){return this.on(e,t,r)};e.prototype.setGuiStyle=function(e){this.gui.setGuiStyle(e);return this};e.prototype.setVideoFit=function(e){this.gui.setVideoFit(e);return this};e.prototype.accessCamera=function(){return(0,tslib_1.__awaiter)(this,void 0,void 0,function(){return(0,tslib_1.__generator)(this,function(e){switch(e.label){case 0:if(!(!this.cameraAccess||this.getActiveCamera()==null))return[3,2];return[4,this.cameraManager.setupCameras()];case 1:e.sent();this.cameraAccess=true;e.label=2;case 2:return[2,this]}})})};e.prototype.createParserForFormat=function(e){return this.scanner.createParserForFormat(e)};e.prototype.reassignOriginElement=function(e){if(!browserHelper_1.BrowserHelper.isValidHTMLElement(e)){throw new customError_1.CustomError({name:"NoOriginElementError",message:"A valid origin HTML element must be given"})}this.gui.reassignOriginElement(e);return this};e.prototype.setTargetScanningFPS=function(e){if(e<=0){e=30}this.targetScanningFPS=e;return this};e.prototype.getScanner=function(){return this.scanner};e.prototype.clearSession=function(){this.scanner.clearSession();return this};e.prototype.setLaserArea=function(e){this.gui.setLaserArea(e);return this};e.prototype.setViewfinderArea=function(e){this.gui.setViewfinderArea(e);return this};e.prototype.pauseCameraAccess=function(){this.cameraAccess=false;this.cameraManager.stopStream().catch(function(){});return this};e.prototype.triggerCameraAccessError=function(e){this.eventEmitter.emit("cameraAccessError",e)};e.prototype.handleScanResult=function(e){var t=this;e.imageData=this.externalImageData;this.eventEmitter.emit("processFrame",e);if(e.barcodes.length!==0||e.texts.length!==0){this.eventEmitter.once("scan",function(){var r;var n=e.barcodes.some(function(t){return!e.rejectedCodes.has(t)});var i=e.texts.some(function(t){return!e.rejectedTexts.has(t)});if(n||i){t.gui.flashGUI();if(t.playSoundOnScan){t.beepSound.play()}if(t.vibrateOnScan){(r=t.vibrateFunction)===null||r===void 0?void 0:r.call(navigator,300)}}});this.eventEmitter.emit("scan",e)}};e.prototype.scheduleVideoProcessing=function(e){var t=this;if(e===void 0){e=0}window.setTimeout(function(){return(0,tslib_1.__awaiter)(t,void 0,void 0,function(){return(0,tslib_1.__generator)(this,function(e){switch(e.label){case 0:return[4,this.videoProcessing()];case 1:e.sent();return[2]}})})},e)};e.prototype.scheduleNextVideoProcessing=function(e){return(0,tslib_1.__awaiter)(this,void 0,void 0,function(){var t;return(0,tslib_1.__generator)(this,function(r){switch(r.label){case 0:if(!(this.targetScanningFPS<60))return[3,4];if(this.averageProcessingTime==null){this.averageProcessingTime=performance.now()-e}else{this.averageProcessingTime=this.averageProcessingTime*.9+(performance.now()-e)*.1}t=Math.max(0,1e3/this.targetScanningFPS-this.averageProcessingTime);if(!(Math.round(t)<=16))return[3,2];return[4,this.videoProcessing()];case 1:r.sent();return[3,3];case 2:this.scheduleVideoProcessing(t);r.label=3;case 3:return[3,6];case 4:return[4,this.videoProcessing()];case 5:r.sent();r.label=6;case 6:return[2]}})})};e.prototype.processVideoFrame=function(e){return(0,tslib_1.__awaiter)(this,void 0,void 0,function(){var t,r;return(0,tslib_1.__generator)(this,function(n){switch(n.label){case 0:this.internalImageData=this.gui.getImageData(this.internalImageData);if(this.internalImageData==null){return[2]}if(this.externalImageData==null||this.externalImageData.byteLength===0||this.externalImageData.byteLength!==this.internalImageData.byteLength){this.externalImageData=new Uint8Array(this.internalImageData)}else{this.externalImageData.set(this.internalImageData)}if(!!this.scanningPaused)return[3,4];if(this.eventEmitter.listenerCount("submitFrame")>0){this.eventEmitter.emit("submitFrame",new scanResult_1.ScanResult([],[],this.externalImageData,this.scanner.getImageSettings()))}n.label=1;case 1:n.trys.push([1,3,,4]);return[4,this.scanner.processImage(this.internalImageData,e)];case 2:t=n.sent();this.internalImageData=t.imageData;if(!this.scanningPaused){this.handleScanResult(t)}return[3,4];case 3:r=n.sent();this.internalImageData=undefined;if(r.name==="ImageSettingsDataMismatch"){return[2]}this.pauseScanning();this.eventEmitter.emit("scanError",r);return[3,4];case 4:return[2]}})})};e.prototype.videoProcessing=function(){var e;return(0,tslib_1.__awaiter)(this,void 0,void 0,function(){var t;return(0,tslib_1.__generator)(this,function(r){switch(r.label){case 0:if(this.destroyed){return[2]}if(((e=this.getActiveCamera())===null||e===void 0?void 0:e.currentResolution)==null||this.scanningPaused||!this.scanner.isReady()||this.scanner.isBusyProcessing()||this.latestVideoTimeProcessed===this.gui.getVideoCurrentTime()){this.scheduleVideoProcessing();return[2]}if(!(this.latestVideoTimeProcessed==null))return[3,2];return[4,this.resumeScanning()];case 1:r.sent();r.label=2;case 2:t=performance.now();this.latestVideoTimeProcessed=this.gui.getVideoCurrentTime();return[4,this.processVideoFrame(false)];case 3:r.sent();return[4,this.scheduleNextVideoProcessing(t)];case 4:r.sent();return[2]}})})};e.prototype.handleScannerReady=function(){this.isReadyToWork=true;this.eventEmitter.emit("ready")};return e}();exports.BarcodePicker=BarcodePicker;(function(e){var t;(function(e){
/**
         * No GUI is shown to indicate where the barcode/text should be placed.
         * Be aware that the Scandit logo continues to be displayed as showing it is part of the license agreement.
         */
e["NONE"]="none";e["LASER"]="laser";e["VIEWFINDER"]="viewfinder"})(t=e.GuiStyle||(e.GuiStyle={}));var r;(function(e){e["CONTAIN"]="contain";e["COVER"]="cover"})(r=e.ObjectFit||(e.ObjectFit={}))})(BarcodePicker=exports.BarcodePicker||(exports.BarcodePicker={}));exports.BarcodePicker=BarcodePicker;