"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.CameraManager=exports.CameraResolutionConstraint=exports.MeteringMode=void 0;var tslib_1=require("tslib");var browserHelper_1=require("../browserHelper");var camera_1=require("../camera");var cameraAccess_1=require("../cameraAccess");var cameraSettings_1=require("../cameraSettings");var customError_1=require("../customError");var logger_1=require("../logger");var MeteringMode;(function(e){e["CONTINUOUS"]="continuous";e["MANUAL"]="manual";e["NONE"]="none";e["SINGLE_SHOT"]="single-shot"})(MeteringMode=exports.MeteringMode||(exports.MeteringMode={}));var CameraResolutionConstraint;(function(e){e[e["ULTRA_HD"]=0]="ULTRA_HD";e[e["FULL_HD"]=1]="FULL_HD";e[e["HD"]=2]="HD";e[e["SD"]=3]="SD";e[e["NONE"]=4]="NONE"})(CameraResolutionConstraint=exports.CameraResolutionConstraint||(exports.CameraResolutionConstraint={}));var CameraManager=function(){function e(e,t,i){this.postStreamInitializationListener=this.postStreamInitialization.bind(this);this.videoResizeListener=this.videoResizeHandle.bind(this);this.videoTrackEndedListener=this.videoTrackEndedRecovery.bind(this);this.videoTrackMuteListener=this.videoTrackMuteRecovery.bind(this);this.triggerManualFocusListener=this.triggerManualFocus.bind(this);this.triggerZoomStartListener=this.triggerZoomStart.bind(this);this.triggerZoomMoveListener=this.triggerZoomMove.bind(this);this.scanner=e;this.triggerCameraAccessError=t;this.gui=i;this.cameraType=camera_1.Camera.Type.BACK}e.prototype.setInteractionOptions=function(e,t,i,r){this.cameraSwitcherEnabled=e;this.torchToggleEnabled=t;this.tapToFocusEnabled=i;this.pinchToZoomEnabled=r};e.prototype.isCameraSwitcherEnabled=function(){return this.cameraSwitcherEnabled};e.prototype.setCameraSwitcherEnabled=function(e){return(0,tslib_1.__awaiter)(this,void 0,void 0,function(){var t;return(0,tslib_1.__generator)(this,function(i){switch(i.label){case 0:this.cameraSwitcherEnabled=e;if(!this.cameraSwitcherEnabled)return[3,2];return[4,cameraAccess_1.CameraAccess.getCameras()];case 1:t=i.sent();if(t.length>1){this.gui.setCameraSwitcherVisible(true)}return[3,3];case 2:this.gui.setCameraSwitcherVisible(false);i.label=3;case 3:return[2]}})})};e.prototype.isTorchToggleEnabled=function(){return this.torchToggleEnabled};e.prototype.setTorchToggleEnabled=function(e){var t;this.torchToggleEnabled=e;if(this.torchToggleEnabled){if(this.mediaStream!=null&&((t=this.mediaTrackCapabilities)===null||t===void 0?void 0:t.torch)===true){this.gui.setTorchTogglerVisible(true)}}else{this.gui.setTorchTogglerVisible(false)}};e.prototype.isTapToFocusEnabled=function(){return this.tapToFocusEnabled};e.prototype.setTapToFocusEnabled=function(e){this.tapToFocusEnabled=e;if(this.mediaStream!=null){if(this.tapToFocusEnabled){this.enableTapToFocusListeners()}else{this.disableTapToFocusListeners()}}};e.prototype.isPinchToZoomEnabled=function(){return this.pinchToZoomEnabled};e.prototype.setPinchToZoomEnabled=function(e){this.pinchToZoomEnabled=e;if(this.mediaStream!=null){if(this.pinchToZoomEnabled){this.enablePinchToZoomListeners()}else{this.disablePinchToZoomListeners()}}};e.prototype.setInitialCameraType=function(e){this.cameraType=e};e.prototype.setCameraType=function(e){return(0,tslib_1.__awaiter)(this,void 0,void 0,function(){var t,i,r;return(0,tslib_1.__generator)(this,function(a){switch(a.label){case 0:this.setInitialCameraType(e);r=(i=cameraAccess_1.CameraAccess).getMainCameraForType;return[4,cameraAccess_1.CameraAccess.getCameras()];case 1:t=r.apply(i,[a.sent(),e]);if(t!=null&&t!==this.selectedCamera){return[2,this.initializeCameraWithSettings(t,this.selectedCameraSettings)]}return[2]}})})};e.prototype.setSelectedCamera=function(e){this.selectedCamera=e};e.prototype.setSelectedCameraSettings=function(e){this.selectedCameraSettings=e};e.prototype.setupCameras=function(){return(0,tslib_1.__awaiter)(this,void 0,void 0,function(){return(0,tslib_1.__generator)(this,function(e){if(this.cameraSetupPromise!=null){return[2,this.cameraSetupPromise]}this.cameraSetupPromise=this.setupCamerasAndStream();return[2,this.cameraSetupPromise]})})};e.prototype.stopStream=function(e){if(e===void 0){e=false}return(0,tslib_1.__awaiter)(this,void 0,void 0,function(){var t=this;return(0,tslib_1.__generator)(this,function(i){if(this.activeCamera!=null){this.activeCamera.currentResolution=undefined}this.activeCamera=undefined;if(this.mediaStream!=null){logger_1.Logger.log(logger_1.Logger.Level.DEBUG,"Stop camera video stream access (stream):",this.mediaStream);window.clearTimeout(this.cameraAccessTimeout);window.clearInterval(this.videoMetadataCheckInterval);window.clearTimeout(this.getCapabilitiesTimeout);window.clearTimeout(this.manualFocusWaitTimeout);window.clearTimeout(this.manualToAutofocusResumeTimeout);window.clearInterval(this.autofocusInterval);this.gui.videoElement.pause();return[2,new Promise(function(i){setTimeout(function(){var r,a;(r=t.mediaStream)===null||r===void 0?void 0:r.getVideoTracks().forEach(function(e){e.removeEventListener("ended",t.videoTrackEndedListener);e.stop()});t.gui.videoElement.srcObject=null;t.mediaStream=undefined;t.mediaTrackCapabilities=undefined;if(!e){(a=t.abortedCameraInitializationResolveCallback)===null||a===void 0?void 0:a.call(t)}i()},0)})]}return[2]})})};e.prototype.applyCameraSettings=function(t){return(0,tslib_1.__awaiter)(this,void 0,void 0,function(){return(0,tslib_1.__generator)(this,function(i){this.selectedCameraSettings=t;if(this.activeCamera==null){throw new customError_1.CustomError(e.noCameraErrorParameters)}return[2,this.initializeCameraWithSettings(this.activeCamera,t)]})})};e.prototype.reinitializeCamera=function(){return(0,tslib_1.__awaiter)(this,void 0,void 0,function(){var e;return(0,tslib_1.__generator)(this,function(t){switch(t.label){case 0:if(!(this.activeCamera==null))return[3,1];logger_1.Logger.log(logger_1.Logger.Level.DEBUG,"Camera reinitialization delayed");return[3,5];case 1:logger_1.Logger.log(logger_1.Logger.Level.DEBUG,"Reinitialize camera:",this.activeCamera);t.label=2;case 2:t.trys.push([2,4,,5]);return[4,this.initializeCameraWithSettings(this.activeCamera,this.activeCameraSettings)];case 3:t.sent();return[3,5];case 4:e=t.sent();logger_1.Logger.log(logger_1.Logger.Level.WARN,"Couldn't access camera:",this.activeCamera,e);this.triggerCameraAccessError(e);throw e;case 5:return[2]}})})};e.prototype.initializeCameraWithSettings=function(e,t){return(0,tslib_1.__awaiter)(this,void 0,void 0,function(){return(0,tslib_1.__generator)(this,function(i){switch(i.label){case 0:if(!(this.cameraInitializationPromise!=null))return[3,2];return[4,this.cameraInitializationPromise];case 1:i.sent();i.label=2;case 2:this.setSelectedCamera(e);this.selectedCameraSettings=this.activeCameraSettings=t;this.cameraInitializationPromise=this.initializeCameraAndCheckUpdatedSettings(e);return[2,this.cameraInitializationPromise]}})})};e.prototype.setTorchEnabled=function(e){var t;return(0,tslib_1.__awaiter)(this,void 0,void 0,function(){var i;return(0,tslib_1.__generator)(this,function(r){switch(r.label){case 0:if(!(this.mediaStream!=null&&((t=this.mediaTrackCapabilities)===null||t===void 0?void 0:t.torch)===true))return[3,2];this.torchEnabled=e;i=this.mediaStream.getVideoTracks();if(!(i.length!==0&&typeof i[0].applyConstraints==="function"))return[3,2];return[4,i[0].applyConstraints({advanced:[{torch:e}]})];case 1:r.sent();r.label=2;case 2:return[2]}})})};e.prototype.toggleTorch=function(){return(0,tslib_1.__awaiter)(this,void 0,void 0,function(){return(0,tslib_1.__generator)(this,function(e){switch(e.label){case 0:this.torchEnabled=!this.torchEnabled;return[4,this.setTorchEnabled(this.torchEnabled)];case 1:e.sent();return[2]}})})};e.prototype.setZoom=function(e,t){var i;return(0,tslib_1.__awaiter)(this,void 0,void 0,function(){var r,a,s;return(0,tslib_1.__generator)(this,function(o){switch(o.label){case 0:if(!(this.mediaStream!=null&&((i=this.mediaTrackCapabilities)===null||i===void 0?void 0:i.zoom)!=null))return[3,2];r=this.mediaStream.getVideoTracks();if(!(r.length!==0&&typeof r[0].applyConstraints==="function"))return[3,2];a=this.mediaTrackCapabilities.zoom.max-this.mediaTrackCapabilities.zoom.min;s=Math.max(this.mediaTrackCapabilities.zoom.min,Math.min((t!==null&&t!==void 0?t:this.mediaTrackCapabilities.zoom.min)+a*e,this.mediaTrackCapabilities.zoom.max));return[4,r[0].applyConstraints({advanced:[{zoom:s}]})];case 1:o.sent();o.label=2;case 2:return[2]}})})};e.prototype.recoverStreamIfNeeded=function(){var e,t;return(0,tslib_1.__awaiter)(this,void 0,void 0,function(){var i;return(0,tslib_1.__generator)(this,function(r){switch(r.label){case 0:i=(e=this.mediaStream)===null||e===void 0?void 0:e.getVideoTracks();if(!(((t=i===null||i===void 0?void 0:i[0])===null||t===void 0?void 0:t.readyState)==="ended"))return[3,2];return[4,this.reinitializeCamera()];case 1:r.sent();r.label=2;case 2:return[2]}})})};e.prototype.setupCamerasAndStream=function(){var e,t,i;return(0,tslib_1.__awaiter)(this,void 0,void 0,function(){var r,a,s,o;return(0,tslib_1.__generator)(this,function(n){switch(n.label){case 0:n.trys.push([0,,13,14]);if(!(this.selectedCamera==null))return[3,2];this.gui.setVideoVisible(false);return[4,this.accessInitialCamera()];case 1:r=n.sent();n.label=2;case 2:return[4,cameraAccess_1.CameraAccess.getCameras(false,true)];case 3:a=n.sent();if(this.cameraSwitcherEnabled&&a.length>1){this.gui.setCameraSwitcherVisible(true)}s=(i=(t=(e=this.mediaStream)===null||e===void 0?void 0:e.getVideoTracks()[0])===null||t===void 0?void 0:t.getSettings)===null||i===void 0?void 0:i.call(t).deviceId;if(!(this.mediaStream!=null&&r!=null))return[3,8];o=a.length===1?a[0]:a.find(function(e){return e.deviceId===s||e.label!==""&&e.label===(r===null||r===void 0?void 0:r.label)});if(!(o!=null))return[3,7];cameraAccess_1.CameraAccess.adjustCameraFromMediaStream(this.mediaStream,o);if(browserHelper_1.BrowserHelper.isDesktopDevice()){cameraAccess_1.CameraAccess.mainCameraForTypeOverridesOnDesktop.set(this.cameraType,o);cameraAccess_1.CameraAccess.mainCameraForTypeOverridesOnDesktop.set(o.cameraType,o)}if(!(a.length===1||cameraAccess_1.CameraAccess.getMainCameraForType(a,this.cameraType)===o))return[3,5];logger_1.Logger.log(logger_1.Logger.Level.DEBUG,"Initial camera access was correct (main camera), keep camera:",o);this.setSelectedCamera(o);this.updateActiveCameraCurrentResolution(o);return[4,this.recoverStreamIfNeeded()];case 4:n.sent();return[2];case 5:logger_1.Logger.log(logger_1.Logger.Level.DEBUG,"Initial camera access was incorrect (not main camera), change camera",(0,tslib_1.__assign)((0,tslib_1.__assign)({},r),{deviceId:s}));n.label=6;case 6:return[3,8];case 7:logger_1.Logger.log(logger_1.Logger.Level.DEBUG,"Initial camera access was incorrect (unknown camera), change camera",(0,tslib_1.__assign)((0,tslib_1.__assign)({},r),{deviceId:s}));n.label=8;case 8:if(!(this.selectedCamera==null))return[3,10];return[4,this.accessAutoselectedCamera(a)];case 9:return[2,n.sent()];case 10:return[4,this.initializeCameraWithSettings(this.selectedCamera,this.selectedCameraSettings)];case 11:return[2,n.sent()];case 12:return[3,14];case 13:this.gui.setVideoVisible(true);this.cameraSetupPromise=undefined;return[7];case 14:return[2]}})})};e.prototype.getInitialCameraResolutionConstraint=function(){var e;var t;switch((e=this.activeCameraSettings)===null||e===void 0?void 0:e.resolutionPreference){case cameraSettings_1.CameraSettings.ResolutionPreference.ULTRA_HD:t=CameraResolutionConstraint.ULTRA_HD;break;case cameraSettings_1.CameraSettings.ResolutionPreference.FULL_HD:t=CameraResolutionConstraint.FULL_HD;break;case cameraSettings_1.CameraSettings.ResolutionPreference.HD:default:t=CameraResolutionConstraint.HD;break}return t};e.prototype.accessAutoselectedCamera=function(t){return(0,tslib_1.__awaiter)(this,void 0,void 0,function(){var i,r;return(0,tslib_1.__generator)(this,function(a){switch(a.label){case 0:t=cameraAccess_1.CameraAccess.sortCamerasForCameraType(t,this.cameraType);i=t.shift();a.label=1;case 1:if(!(i!=null))return[3,6];a.label=2;case 2:a.trys.push([2,4,,5]);return[4,this.initializeCameraWithSettings(i,this.selectedCameraSettings)];case 3:return[2,a.sent()];case 4:r=a.sent();this.setSelectedCamera();if(t.length===1){this.gui.setCameraSwitcherVisible(false)}if(t.length>=1){logger_1.Logger.log(logger_1.Logger.Level.WARN,"Couldn't access camera:",i,r);i=t.shift();return[3,1]}throw r;case 5:return[3,1];case 6:throw new customError_1.CustomError(e.noCameraErrorParameters)}})})};e.prototype.accessInitialCamera=function(){return(0,tslib_1.__awaiter)(this,void 0,void 0,function(){var e,t;return(0,tslib_1.__generator)(this,function(i){switch(i.label){case 0:e={deviceId:"",label:"",cameraType:this.cameraType};i.label=1;case 1:i.trys.push([1,3,4,5]);return[4,this.initializeCameraWithSettings(e,this.selectedCameraSettings)];case 2:i.sent();return[3,5];case 3:t=i.sent();return[3,5];case 4:this.setSelectedCamera();return[7];case 5:return[2,e]}})})};e.prototype.updateActiveCameraCurrentResolution=function(e){if(this.gui.videoElement.videoWidth>2&&this.gui.videoElement.videoHeight>2){e.currentResolution={width:this.gui.videoElement.videoWidth,height:this.gui.videoElement.videoHeight}}if(e.deviceId!==""){this.activeCamera=e;this.gui.setMirrorImageEnabled(this.gui.isMirrorImageEnabled(),false)}};e.prototype.postStreamInitialization=function(){var t=this;window.clearTimeout(this.getCapabilitiesTimeout);this.getCapabilitiesTimeout=window.setTimeout(function(){var e;t.storeStreamCapabilities();t.setupAutofocus();if(t.torchToggleEnabled&&t.mediaStream!=null&&((e=t.mediaTrackCapabilities)===null||e===void 0?void 0:e.torch)===true){t.gui.setTorchTogglerVisible(true)}},e.getCapabilitiesTimeoutMs)};e.prototype.videoResizeHandle=function(){if(this.activeCamera!=null){this.updateActiveCameraCurrentResolution(this.activeCamera)}};e.prototype.videoTrackEndedRecovery=function(){return(0,tslib_1.__awaiter)(this,void 0,void 0,function(){var e;return(0,tslib_1.__generator)(this,function(t){switch(t.label){case 0:t.trys.push([0,2,,3]);logger_1.Logger.log(logger_1.Logger.Level.DEBUG,'Detected video track "ended" event, try to reinitialize camera');return[4,this.reinitializeCamera()];case 1:t.sent();return[3,3];case 2:e=t.sent();return[3,3];case 3:return[2]}})})};e.prototype.videoTrackMuteRecovery=function(e){return(0,tslib_1.__awaiter)(this,void 0,void 0,function(){var t;return(0,tslib_1.__generator)(this,function(i){if(this.gui.videoElement.onloadeddata!=null){logger_1.Logger.log(logger_1.Logger.Level.DEBUG,'Detected video track "'.concat(e.type,'" event, delay video stream access detection'));this.setCameraAccessTimeout();return[2]}t=e.type==="mute";if(t!==this.gui.isCameraRecoveryVisible()){logger_1.Logger.log(logger_1.Logger.Level.DEBUG,'Detected video track "'.concat(e.type,'" event, ').concat(t?"enable":"disable"," camera recovery"));this.gui.setCameraRecoveryVisible(t)}return[2]})})};e.prototype.triggerManualFocusForContinuous=function(){return(0,tslib_1.__awaiter)(this,void 0,void 0,function(){var t=this;return(0,tslib_1.__generator)(this,function(i){switch(i.label){case 0:this.manualToAutofocusResumeTimeout=window.setTimeout(function(){return(0,tslib_1.__awaiter)(t,void 0,void 0,function(){return(0,tslib_1.__generator)(this,function(e){switch(e.label){case 0:return[4,this.triggerFocusMode(MeteringMode.CONTINUOUS)];case 1:e.sent();return[2]}})})},e.manualToAutofocusResumeTimeoutMs);return[4,this.triggerFocusMode(MeteringMode.CONTINUOUS)];case 1:i.sent();this.manualFocusWaitTimeout=window.setTimeout(function(){return(0,tslib_1.__awaiter)(t,void 0,void 0,function(){return(0,tslib_1.__generator)(this,function(e){switch(e.label){case 0:return[4,this.triggerFocusMode(MeteringMode.MANUAL)];case 1:e.sent();return[2]}})})},e.manualFocusWaitTimeoutMs);return[2]}})})};e.prototype.triggerManualFocusForSingleShot=function(){return(0,tslib_1.__awaiter)(this,void 0,void 0,function(){var t;var i=this;return(0,tslib_1.__generator)(this,function(r){switch(r.label){case 0:window.clearInterval(this.autofocusInterval);this.manualToAutofocusResumeTimeout=window.setTimeout(function(){i.autofocusInterval=window.setInterval(i.triggerAutoFocus.bind(i),e.autofocusIntervalMs)},e.manualToAutofocusResumeTimeoutMs);r.label=1;case 1:r.trys.push([1,3,,4]);return[4,this.triggerFocusMode(MeteringMode.SINGLE_SHOT)];case 2:r.sent();return[3,4];case 3:t=r.sent();return[3,4];case 4:return[2]}})})};e.prototype.triggerManualFocus=function(e){return(0,tslib_1.__awaiter)(this,void 0,void 0,function(){var t;return(0,tslib_1.__generator)(this,function(i){switch(i.label){case 0:if(e!=null){e.preventDefault();if(e.type==="touchend"&&e.touches.length!==0){return[2]}if(this.pinchToZoomDistance!=null){this.pinchToZoomDistance=undefined;return[2]}}window.clearTimeout(this.manualFocusWaitTimeout);window.clearTimeout(this.manualToAutofocusResumeTimeout);if(!(this.mediaStream!=null&&this.mediaTrackCapabilities!=null))return[3,4];t=this.mediaTrackCapabilities.focusMode;if(!(t instanceof Array&&t.includes(MeteringMode.SINGLE_SHOT)))return[3,4];if(!(t.includes(MeteringMode.CONTINUOUS)&&t.includes(MeteringMode.MANUAL)))return[3,2];return[4,this.triggerManualFocusForContinuous()];case 1:i.sent();return[3,4];case 2:if(!!t.includes(MeteringMode.CONTINUOUS))return[3,4];return[4,this.triggerManualFocusForSingleShot()];case 3:i.sent();i.label=4;case 4:return[2]}})})};e.prototype.triggerZoomStart=function(e){var t;if((e===null||e===void 0?void 0:e.touches.length)!==2){return}e.preventDefault();this.pinchToZoomDistance=Math.hypot((e.touches[1].screenX-e.touches[0].screenX)/screen.width,(e.touches[1].screenY-e.touches[0].screenY)/screen.height);if(this.mediaStream!=null&&((t=this.mediaTrackCapabilities)===null||t===void 0?void 0:t.zoom)!=null){var i=this.mediaStream.getVideoTracks();if(i.length!==0&&typeof i[0].getConstraints==="function"){this.pinchToZoomInitialZoom=this.mediaTrackCapabilities.zoom.min;var r=i[0].getConstraints();if(r.advanced!=null){var a=r.advanced.find(function(e){return"zoom"in e});if((a===null||a===void 0?void 0:a.zoom)!=null){this.pinchToZoomInitialZoom=a.zoom}}}}};e.prototype.triggerZoomMove=function(e){return(0,tslib_1.__awaiter)(this,void 0,void 0,function(){return(0,tslib_1.__generator)(this,function(t){switch(t.label){case 0:if(this.pinchToZoomDistance==null||(e===null||e===void 0?void 0:e.touches.length)!==2){return[2]}e.preventDefault();return[4,this.setZoom((Math.hypot((e.touches[1].screenX-e.touches[0].screenX)/screen.width,(e.touches[1].screenY-e.touches[0].screenY)/screen.height)-this.pinchToZoomDistance)*2,this.pinchToZoomInitialZoom)];case 1:t.sent();return[2]}})})};e.prototype.storeStreamCapabilities=function(){var e;if(this.mediaStream!=null){var t=this.mediaStream.getVideoTracks();if(t.length!==0&&typeof t[0].getCapabilities==="function"){this.mediaTrackCapabilities=t[0].getCapabilities()}}if(this.activeCamera!=null){this.scanner.reportCameraProperties(this.activeCamera.cameraType,((e=this.mediaTrackCapabilities)===null||e===void 0?void 0:e.focusMode)==null||this.mediaTrackCapabilities.focusMode.includes(MeteringMode.CONTINUOUS))}};e.prototype.setupAutofocus=function(){window.clearTimeout(this.manualFocusWaitTimeout);window.clearTimeout(this.manualToAutofocusResumeTimeout);if(this.mediaStream!=null&&this.mediaTrackCapabilities!=null){var t=this.mediaTrackCapabilities.focusMode;if(t instanceof Array&&!t.includes(MeteringMode.CONTINUOUS)&&t.includes(MeteringMode.SINGLE_SHOT)){window.clearInterval(this.autofocusInterval);this.autofocusInterval=window.setInterval(this.triggerAutoFocus.bind(this),e.autofocusIntervalMs)}}};e.prototype.triggerAutoFocus=function(){return(0,tslib_1.__awaiter)(this,void 0,void 0,function(){return(0,tslib_1.__generator)(this,function(e){switch(e.label){case 0:return[4,this.triggerFocusMode(MeteringMode.SINGLE_SHOT)];case 1:e.sent();return[2]}})})};e.prototype.triggerFocusMode=function(e){return(0,tslib_1.__awaiter)(this,void 0,void 0,function(){var t,i;return(0,tslib_1.__generator)(this,function(r){switch(r.label){case 0:if(!(this.mediaStream!=null))return[3,4];t=this.mediaStream.getVideoTracks();if(!(t.length!==0&&typeof t[0].applyConstraints==="function"))return[3,4];r.label=1;case 1:r.trys.push([1,3,,4]);return[4,t[0].applyConstraints({advanced:[{focusMode:e}]})];case 2:r.sent();return[3,4];case 3:i=r.sent();return[3,4];case 4:return[2]}})})};e.prototype.enableTapToFocusListeners=function(){var e=this;["touchend","mousedown"].forEach(function(t){e.gui.videoElement.addEventListener(t,e.triggerManualFocusListener)})};e.prototype.enablePinchToZoomListeners=function(){this.gui.videoElement.addEventListener("touchstart",this.triggerZoomStartListener);this.gui.videoElement.addEventListener("touchmove",this.triggerZoomMoveListener)};e.prototype.disableTapToFocusListeners=function(){var e=this;["touchend","mousedown"].forEach(function(t){e.gui.videoElement.removeEventListener(t,e.triggerManualFocusListener)})};e.prototype.disablePinchToZoomListeners=function(){this.gui.videoElement.removeEventListener("touchstart",this.triggerZoomStartListener);this.gui.videoElement.removeEventListener("touchmove",this.triggerZoomMoveListener)};e.prototype.initializeCameraAndCheckUpdatedSettings=function(e){return(0,tslib_1.__awaiter)(this,void 0,void 0,function(){var t=this;return(0,tslib_1.__generator)(this,function(i){switch(i.label){case 0:i.trys.push([0,,4,5]);return[4,this.initializeCamera(e)];case 1:i.sent();if(!(this.selectedCameraSettings!==this.activeCameraSettings&&(this.selectedCameraSettings==null||this.activeCameraSettings==null||Object.keys(this.selectedCameraSettings).some(function(e){return t.selectedCameraSettings[e]!==t.activeCameraSettings[e]}))))return[3,3];this.activeCameraSettings=this.selectedCameraSettings;return[4,this.initializeCameraAndCheckUpdatedSettings(e)];case 2:return[2,i.sent()];case 3:return[3,5];case 4:this.cameraInitializationPromise=undefined;return[7];case 5:return[2]}})})};e.prototype.handleCameraInitializationError=function(e,t,i){return(0,tslib_1.__awaiter)(this,void 0,void 0,function(){var r;return(0,tslib_1.__generator)(this,function(a){switch(a.label){case 0:if(!["OverconstrainedError","NotReadableError"].includes(i.name)||i.name==="NotReadableError"&&t===CameraResolutionConstraint.NONE){logger_1.Logger.log(logger_1.Logger.Level.DEBUG,"Camera video stream access failure (unrecoverable error)",e,i);if(i.name!=="NotAllowedError"){cameraAccess_1.CameraAccess.markCameraAsInaccessible(e)}throw i}if(!(i.name==="OverconstrainedError"&&t===CameraResolutionConstraint.NONE))return[3,2];if(e.deviceId===""){logger_1.Logger.log(logger_1.Logger.Level.DEBUG,"Camera video stream access failure (no camera with such type error)",e,i);throw i}logger_1.Logger.log(logger_1.Logger.Level.DEBUG,"Detected non-existent deviceId error, attempt to find and reaccess updated camera",e,i);r=e.deviceId;return[4,cameraAccess_1.CameraAccess.getCameras(true)];case 1:a.sent();if(r===e.deviceId){logger_1.Logger.log(logger_1.Logger.Level.DEBUG,"Camera video stream access failure (updated camera not found after non-existent deviceId error)",e,i);cameraAccess_1.CameraAccess.markCameraAsInaccessible(e);throw i}else{logger_1.Logger.log(logger_1.Logger.Level.DEBUG,"Updated camera found (recovered from non-existent deviceId error), attempt to access it",e);return[2,this.initializeCamera(e)]}a.label=2;case 2:return[2,this.initializeCamera(e,t+1)]}})})};e.prototype.initializeCamera=function(t,i){return(0,tslib_1.__awaiter)(this,void 0,void 0,function(){var r,a,s,o;var n=this;return(0,tslib_1.__generator)(this,function(c){switch(c.label){case 0:this.gui.setCameraRecoveryVisible(false);if(t==null){throw new customError_1.CustomError(e.noCameraErrorParameters)}return[4,this.stopStream()];case 1:c.sent();this.torchEnabled=false;this.gui.setTorchTogglerVisible(false);i!==null&&i!==void 0?i:i=this.getInitialCameraResolutionConstraint();c.label=2;case 2:c.trys.push([2,8,,9]);return[4,cameraAccess_1.CameraAccess.accessCameraStream(i,t)];case 3:r=c.sent();logger_1.Logger.log(logger_1.Logger.Level.DEBUG,"Camera accessed, waiting for video stream start...");if(typeof r.getTracks()[0].getSettings==="function"){a=r.getTracks()[0].getSettings();if(a.width!=null&&a.height!=null&&(a.width===2||a.height===2)){logger_1.Logger.log(logger_1.Logger.Level.DEBUG,"Camera video stream access failure (invalid video metadata):",t);if(i===CameraResolutionConstraint.NONE){throw new customError_1.CustomError(e.notReadableErrorParameters)}else{return[2,this.initializeCamera(t,i+1)]}}}this.mediaStream=r;this.mediaStream.getVideoTracks().forEach(function(e){e.addEventListener("ended",n.videoTrackEndedListener);e.addEventListener("mute",n.videoTrackMuteListener);e.addEventListener("unmute",n.videoTrackMuteListener)});c.label=4;case 4:c.trys.push([4,6,,7]);return[4,this.setupCameraStreamVideo(t,r)];case 5:c.sent();return[3,7];case 6:s=c.sent();if(i===CameraResolutionConstraint.NONE){throw s}else{return[2,this.initializeCamera(t,i+1)]}return[3,7];case 7:return[3,9];case 8:o=c.sent();return[2,this.handleCameraInitializationError(t,i,o)];case 9:return[2]}})})};e.prototype.setCameraAccessTimeout=function(){var t=this;window.clearTimeout(this.cameraAccessTimeout);this.cameraAccessTimeout=window.setTimeout(function(){return(0,tslib_1.__awaiter)(t,void 0,void 0,function(){var t;return(0,tslib_1.__generator)(this,function(i){switch(i.label){case 0:return[4,this.stopStream(true)];case 1:i.sent();(t=this.cameraAccessRejectCallback)===null||t===void 0?void 0:t.call(this,new customError_1.CustomError(e.notReadableErrorParameters));return[2]}})})},e.cameraAccessTimeoutMs)};e.prototype.checkCameraAccess=function(e){var t=this;return new Promise(function(i,r){t.cameraAccessRejectCallback=function(i){logger_1.Logger.log(logger_1.Logger.Level.DEBUG,"Camera video stream access failure (video data load timeout):",e);t.gui.setCameraRecoveryVisible(true);r(i)};t.setCameraAccessTimeout()})};e.prototype.checkVideoMetadata=function(t){return(0,tslib_1.__awaiter)(this,void 0,void 0,function(){var i=this;return(0,tslib_1.__generator)(this,function(r){return[2,new Promise(function(r,a){i.gui.videoElement.onloadeddata=function(){i.gui.videoElement.onloadeddata=null;window.clearTimeout(i.cameraAccessTimeout);if(i.gui.videoElement.videoWidth>2&&i.gui.videoElement.videoHeight>2&&i.gui.videoElement.currentTime>0){i.updateActiveCameraCurrentResolution(t);logger_1.Logger.log(logger_1.Logger.Level.DEBUG,"Camera video stream access success:",t);return r()}var s=performance.now();window.clearInterval(i.videoMetadataCheckInterval);i.videoMetadataCheckInterval=window.setInterval(function(){return(0,tslib_1.__awaiter)(i,void 0,void 0,function(){return(0,tslib_1.__generator)(this,function(i){switch(i.label){case 0:if(!(this.gui.videoElement.videoWidth<=2||this.gui.videoElement.videoHeight<=2||this.gui.videoElement.currentTime===0))return[3,3];if(!(performance.now()-s>e.videoMetadataCheckTimeoutMs))return[3,2];logger_1.Logger.log(logger_1.Logger.Level.DEBUG,"Camera video stream access failure (valid video metadata timeout):",t);window.clearInterval(this.videoMetadataCheckInterval);return[4,this.stopStream(true)];case 1:i.sent();return[2,a(new customError_1.CustomError(e.notReadableErrorParameters))];case 2:return[2];case 3:window.clearInterval(this.videoMetadataCheckInterval);this.updateActiveCameraCurrentResolution(t);logger_1.Logger.log(logger_1.Logger.Level.DEBUG,"Camera video stream access success:",t);r();return[2]}})})},e.videoMetadataCheckIntervalMs)}})]})})};e.prototype.setupCameraStreamVideo=function(e,t){var i=this;this.gui.videoElement.addEventListener("loadedmetadata",this.postStreamInitializationListener);this.gui.videoElement.addEventListener("resize",this.videoResizeListener);if(this.tapToFocusEnabled){this.enableTapToFocusListeners()}if(this.pinchToZoomEnabled){this.enablePinchToZoomListeners()}var r=Promise.race([this.checkCameraAccess(e),this.checkVideoMetadata(e),new Promise(function(e){i.abortedCameraInitializationResolveCallback=e})]);this.gui.videoElement.srcObject=t;this.gui.videoElement.load();this.gui.playVideo();this.scanner.reportCameraProperties(e.cameraType);return r};e.cameraAccessTimeoutMs=4e3;e.videoMetadataCheckTimeoutMs=4e3;e.videoMetadataCheckIntervalMs=50;e.getCapabilitiesTimeoutMs=500;e.autofocusIntervalMs=1500;e.manualToAutofocusResumeTimeoutMs=5e3;e.manualFocusWaitTimeoutMs=400;e.noCameraErrorParameters={name:"NoCameraAvailableError",message:"No camera available"};e.notReadableErrorParameters={name:"NotReadableError",message:"Could not initialize camera correctly"};return e}();exports.CameraManager=CameraManager;