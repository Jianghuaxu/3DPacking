"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.CameraAccess=void 0;var tslib_1=require("tslib");var cameraManager_1=require("./barcodePicker/cameraManager");var browserCompatibility_1=require("./browserCompatibility");var browserHelper_1=require("./browserHelper");var camera_1=require("./camera");var customError_1=require("./customError");var logger_1=require("./logger");var unsupportedBrowserError_1=require("./unsupportedBrowserError");var CameraAccess;(function(e){var r=new Map([["DeviceCaptureError","AbortError"],["NotSupportedError","AbortError"],["ScreenCaptureError","AbortError"],["TabCaptureError","AbortError"],["TypeError","AbortError"],["InvalidStateError","NotAllowedError"],["MediaDeviceFailedDueToShutdown","NotAllowedError"],["MediaDeviceKillSwitchOn","NotAllowedError"],["PermissionDeniedError","NotAllowedError"],["PermissionDismissedError","NotAllowedError"],["DevicesNotFoundError","NotFoundError"],["SourceUnavailableError","NotReadableError"],["TrackStartError","NotReadableError"],["ConstraintNotSatisfiedError","OverconstrainedError"]]);var a=["rear","back","rück","arrière","trasera","trás","traseira","posteriore","后面","後面","背面","后置","後置","背置","задней","الخلفية","후","arka","achterzijde","หลัง","baksidan","bagside","sau","bak","tylny","takakamera","belakang","אחורית","πίσω","spate","hátsó","zadní","darrere","zadná","задня","stražnja","belakang","बैक"];var t;var i=false;e.mainCameraForTypeOverridesOnDesktop=new Map;e.deviceIdToCameraObjects=new Map;e.inaccessibleDeviceIds=new Set;function n(){i=true}function o(e){var r=e.toLowerCase();return a.some(function(e){return r.includes(e)})}function s(e){var a;var t;if(e.message==="Invalid constraint"){t="OverconstrainedError"}else{t=(a=r.get(e.name))!==null&&a!==void 0?a:e.name}Object.defineProperty(e,"name",{value:t})}function l(r,a){var t;if(browserHelper_1.BrowserHelper.isDesktopDevice()){if(e.mainCameraForTypeOverridesOnDesktop.has(a)){t=e.mainCameraForTypeOverridesOnDesktop.get(a)}else{t=r.filter(function(e){return e.cameraType===a})[0]}}else{var i=r.every(function(e){return e.label===""});var n=r.every(function(e){return e.label!==""});var o=r.length>1&&!i&&!n;if(i){t=r[a===camera_1.Camera.Type.FRONT?0:r.length-1]}else if(o){var s=r.filter(function(e){return e.cameraType===a});if(s.length===1){t=s[0]}else if(s.length>1){t=s[a===camera_1.Camera.Type.FRONT?0:s.length-1]}}else{t=r.filter(function(e){return e.cameraType===a}).sort(function(e,r){return e.label.localeCompare(r.label)})[0]}}return t}e.getMainCameraForType=l;function c(r,a){function t(r,a){var t=e.mainCameraForTypeOverridesOnDesktop.get(a);if(t!=null&&r.includes(t)){r=r.filter(function(e){return e!==t});r.unshift(t)}return r}var i=r.filter(function(e){return e.cameraType===camera_1.Camera.Type.FRONT});var n=r.filter(function(e){return e.cameraType===camera_1.Camera.Type.BACK});if(browserHelper_1.BrowserHelper.isDesktopDevice()){i=t(i,camera_1.Camera.Type.FRONT);n=t(n,camera_1.Camera.Type.BACK)}else if(r.every(function(e){return e.label===""})){n.reverse()}else{i.sort(function(e,r){return e.label.localeCompare(r.label)});n.sort(function(e,r){return e.label.localeCompare(r.label)})}return a===camera_1.Camera.Type.FRONT?(0,tslib_1.__spreadArray)((0,tslib_1.__spreadArray)([],(0,tslib_1.__read)(i),false),(0,tslib_1.__read)(n),false):(0,tslib_1.__spreadArray)((0,tslib_1.__spreadArray)([],(0,tslib_1.__read)(n),false),(0,tslib_1.__read)(i),false)}e.sortCamerasForCameraType=c;function u(e,r){var a=e.getVideoTracks();if(a.length!==0){var t=a[0];var i=void 0;if(typeof t.getSettings==="function"){i=t.getSettings();if((i===null||i===void 0?void 0:i.facingMode)!=null&&i.facingMode.length>0){r.cameraType=i.facingMode==="environment"?camera_1.Camera.Type.BACK:camera_1.Camera.Type.FRONT}}if(t.label!=null&&t.label.length>0){r.label=t.label}}}e.adjustCameraFromMediaStream=u;function d(r){function a(r,a,t){var i;if(e.deviceIdToCameraObjects.has(r.deviceId)){return e.deviceIdToCameraObjects.get(r.deviceId)}var n=(i=r.label)!==null&&i!==void 0?i:"";var s;if(!browserHelper_1.BrowserHelper.isDesktopDevice()&&t.every(function(r){return r.label===""&&!e.deviceIdToCameraObjects.has(r.deviceId)})){s=t.length===1||a+1<=Math.floor(t.length/2)?camera_1.Camera.Type.FRONT:camera_1.Camera.Type.BACK}else{s=o(n)?camera_1.Camera.Type.BACK:camera_1.Camera.Type.FRONT}return{deviceId:r.deviceId,label:n,cameraType:s}}var t=r.map(a).map(function(r){if(r.deviceId!==""){e.deviceIdToCameraObjects.set(r.deviceId,r)}return r}).filter(function(e){return!/\b(?:ir|infrared)\b/i.test(e.label)}).filter(function(r){return!e.inaccessibleDeviceIds.has(r.deviceId)});if(!browserHelper_1.BrowserHelper.isDesktopDevice()&&t.length>1&&!t.some(function(e){return e.cameraType===camera_1.Camera.Type.BACK})){var i=t.length-1;var n=t.map(function(e){var r=e.label.match(/\b([0-9]+)MP?\b/i);if(r!=null){return parseInt(r[1],10)}return NaN});if(!n.some(function(e){return isNaN(e)})){i=n.lastIndexOf(Math.max.apply(Math,(0,tslib_1.__spreadArray)([],(0,tslib_1.__read)(n),false)))}t[i].cameraType=camera_1.Camera.Type.BACK}return t}function v(){return(0,tslib_1.__awaiter)(this,void 0,void 0,function(){var r;return(0,tslib_1.__generator)(this,function(a){switch(a.label){case 0:if(!(t!=null&&t.length>0&&t.every(function(r){return r.label===""&&!e.deviceIdToCameraObjects.has(r.deviceId)})))return[3,4];a.label=1;case 1:a.trys.push([1,3,,4]);return[4,navigator.mediaDevices.getUserMedia({video:true,audio:false})];case 2:return[2,a.sent()];case 3:r=a.sent();return[3,4];case 4:return[2]}})})}function m(r,a){if(a.length>0&&r.length===a.length&&!a.every(function(e,a){return r[a].deviceId===e.deviceId})){var t={};r.forEach(function(r,i){var n;var o=e.deviceIdToCameraObjects.get(r.deviceId);if(o==null||o.label!==((n=a[i].label)!==null&&n!==void 0?n:"")){return}var s=a[i].deviceId;t[o.deviceId]=s;if(e.inaccessibleDeviceIds.has(o.deviceId)){e.inaccessibleDeviceIds.add(s)}o.deviceId=s;e.deviceIdToCameraObjects.set(s,o)});logger_1.Logger.log(logger_1.Logger.Level.DEBUG,"Detected updated camera deviceId information and updated it accordingly",t)}}function _(e,r){if(e===void 0){e=false}if(r===void 0){r=false}return(0,tslib_1.__awaiter)(this,void 0,void 0,function(){var a,o,l,c,u;return(0,tslib_1.__generator)(this,function(_){switch(_.label){case 0:a=browserHelper_1.BrowserHelper.checkBrowserCompatibility();if(!a.fullSupport){throw new unsupportedBrowserError_1.UnsupportedBrowserError(a)}navigator.mediaDevices.addEventListener("devicechange",n);if(!(t==null||e||i))return[3,8];i=false;o=void 0;l=t!==null&&t!==void 0?t:[];t=[];_.label=1;case 1:_.trys.push([1,6,7,8]);return[4,C()];case 2:t=_.sent();if(!!r)return[3,5];return[4,v()];case 3:o=_.sent();if(!(o!=null))return[3,5];return[4,C()];case 4:t=_.sent();_.label=5;case 5:logger_1.Logger.log.apply(logger_1.Logger,(0,tslib_1.__spreadArray)([logger_1.Logger.Level.DEBUG,"Camera list (devices):"],(0,tslib_1.__read)(t),false));m(l,t);return[3,8];case 6:c=_.sent();s(c);throw c;case 7:if(o!=null){o.getVideoTracks().forEach(function(e){e.stop()})}return[7];case 8:u=d(t);logger_1.Logger.log.apply(logger_1.Logger,(0,tslib_1.__spreadArray)([logger_1.Logger.Level.DEBUG,"Camera list (cameras): "],(0,tslib_1.__read)(u),false));return[2,(0,tslib_1.__spreadArray)([],(0,tslib_1.__read)(u),false)]}})})}e.getCameras=_;function f(e){logger_1.Logger.log(logger_1.Logger.Level.DEBUG,"Attempt to access camera (parameters):",e.video);return new Promise(function(r,a){window.setTimeout(function(){var t;((t=navigator.mediaDevices.getUserMedia(e))!==null&&t!==void 0?t:Promise.reject(new customError_1.CustomError({name:"AbortError"}))).then(r).catch(a)},0)})}function g(e){var r={resizeMode:"none"};switch(e){case cameraManager_1.CameraResolutionConstraint.ULTRA_HD:return(0,tslib_1.__assign)((0,tslib_1.__assign)({},r),{width:{min:3200,ideal:3840,max:4096},height:{min:1800,ideal:2160,max:2400}});case cameraManager_1.CameraResolutionConstraint.FULL_HD:return(0,tslib_1.__assign)((0,tslib_1.__assign)({},r),{width:{min:1400,ideal:1920,max:2160},height:{min:900,ideal:1080,max:1440}});case cameraManager_1.CameraResolutionConstraint.HD:return(0,tslib_1.__assign)((0,tslib_1.__assign)({},r),{width:{min:960,ideal:1280,max:1440},height:{min:480,ideal:720,max:960}});case cameraManager_1.CameraResolutionConstraint.SD:return(0,tslib_1.__assign)((0,tslib_1.__assign)({},r),{width:{min:640,ideal:640,max:800},height:{min:480,ideal:480,max:600}});case cameraManager_1.CameraResolutionConstraint.NONE:default:return{}}}function p(e,r){return(0,tslib_1.__awaiter)(this,void 0,void 0,function(){var a,t,i;return(0,tslib_1.__generator)(this,function(n){switch(n.label){case 0:logger_1.Logger.log(logger_1.Logger.Level.DEBUG,"Attempt to access camera (camera):",r);a={audio:false,video:g(e)};if(r.deviceId===""){a.video.facingMode={ideal:r.cameraType===camera_1.Camera.Type.BACK?"environment":"user"}}else{a.video.deviceId={exact:r.deviceId}}n.label=1;case 1:n.trys.push([1,3,,4]);return[4,f(a)];case 2:t=n.sent();u(t,r);return[2,t];case 3:i=n.sent();s(i);if(!["OverconstrainedError","NotReadableError","NotAllowedError"].includes(i.name)){b(r)}throw i;case 4:return[2]}})})}e.accessCameraStream=p;function b(r){if(r.deviceId!==""){logger_1.Logger.log(logger_1.Logger.Level.DEBUG,"Camera marked to be inaccessible:",r);e.inaccessibleDeviceIds.add(r.deviceId)}}e.markCameraAsInaccessible=b;function C(){var e;return(0,tslib_1.__awaiter)(this,void 0,void 0,function(){var r,a;return(0,tslib_1.__generator)(this,function(t){switch(t.label){case 0:if(!(typeof navigator.enumerateDevices==="function"))return[3,2];return[4,navigator.enumerateDevices()];case 1:r=t.sent();return[3,7];case 2:if(!(typeof navigator.mediaDevices==="object"&&typeof navigator.mediaDevices.enumerateDevices==="function"))return[3,4];return[4,navigator.mediaDevices.enumerateDevices()];case 3:r=t.sent();return[3,7];case 4:t.trys.push([4,6,,7]);if(((e=window.MediaStreamTrack)===null||e===void 0?void 0:e.getSources)==null){throw new Error}return[4,new Promise(function(e){var r,a;(a=(r=window.MediaStreamTrack)===null||r===void 0?void 0:r.getSources)===null||a===void 0?void 0:a.call(r,e)})];case 5:r=t.sent();r=r.filter(function(e){return e.kind.toLowerCase()==="video"||e.kind.toLowerCase()==="videoinput"}).map(function(e){var r;return{deviceId:(r=e.deviceId)!==null&&r!==void 0?r:"",groupId:e.groupId,kind:"videoinput",label:e.label,toJSON:function(){return this}}});return[3,7];case 6:a=t.sent();throw new unsupportedBrowserError_1.UnsupportedBrowserError({fullSupport:false,scannerSupport:true,missingFeatures:[browserCompatibility_1.BrowserCompatibility.Feature.MEDIA_DEVICES]});case 7:return[2,r.filter(function(e){return e.kind==="videoinput"})]}})})}})(CameraAccess=exports.CameraAccess||(exports.CameraAccess={}));