sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","project1/modelHelper/PackProductsHelper","sap/ui/vk/ContentResource","sap/ui/vk/ContentConnector","sap/ui/vk/thirdparty/three","sap/ui/vk/Camera","../utils/Util","../libs/scandit-sdk/build/browser/index"],function(e,t,i,n,a,s,r,o){"use strict";return e.extend("project1.controller.Initial",{bcalculate:true,root:new THREE.Group,font:undefined,ratio:20,_scanListModel:new t([]),_scannedProd:[],onInit:function(){this.initThreejsModel();this.fontLoader();this.initScan()},initScan:async function(){this.getView().setModel(this._scanListModel,"scan");
//https://ssl.scandit.com/dashboard/sdk/projects: for creating a license key
var e="AelhPGK0Q/QqARqoEztBkSsu6zcXPYf4cHWg1ysy9Q+kZ7oFpSMvK8NfRsWQJV/FYXLjnBcOZEdyHdejuXmAcgF1GcAGJYRq+ldYsHFrGCk9XP5mnG0wVy9b1c0ReclZdDR0iq8Y7xQHJ7cKwAWdGotEhAG+T0EsV3u81M/zRXWNfd41QLz2hYu0Ie/Bl+SkFPd1rA4wI3hOaT3ob9ZWuul0J+KBb++BMV2+kPmyUOK0yahOQeR6rBage01m0FTcDyQSa5GRBoO0aOdb8IN4nikGTvS1in/8RwNlq1e4AiV6MvN/xsT38lNT5jnr83iWPz4Yt8u0WiDrUC5umOl74vW5Nbd4s0x7MINfN15oslgOO7kDfI2EH76xltFIGYYmjFeVquQ+cXa6tcw9JuyAZav3m1hMdICBFOwJheGDlBNNdzyiuBAWc6rzOmzWb4MAJT1fLdRZ5ImWleUFgx3KVA0xD+kCT5Sy/Pl6TpS5vpIJvjJXtA8xgMHHv1Xno/yyPsqNINKOABzyVgTwgqP4lo6eIyJA6Al61tjWIWUgpDp5f1viAGJU8WYX/ub7F5W16JDIhlIX07+C0P+AFNkgyYjzG7QyWXEuQjbLTwUV4iAnWkS2wuhplWb8G0zAREOwGmNzpxTYnaK/blwHlsG30WzfbbvxcuOmLMvAzHoYJj+utoaG1AiQ7d2j/QUATTidJadOD4QIswIIYNZG9i6O5JIC99kPwwXrNKtXvLMm9VAeSDbjMNrB3R5DW0vdUVRMbVm1v3GDZwHhSSyrkhamcbF8vcV81XZgLg62+os7QMtiPUT9dKkCbSlwBKGMivrgiM1ncTao8WW4S2Xc";
//var licenseKey = "AVZx5Tu0GhkhLUEh8A7SdiIJ0uLtD41dZ0R3fNtvNbAESdrUaATie5l1DED0KWsxJ0p6Tr9KTF7EVb02tnbtFDtkL93lM+ed6lS1tFtpVOB0WF8DCUnsKWh9qWU0SElsCF7H8flkAjLERbF5GnmrR00KpP++C/7GNkaW6Kc2hzlFMiJiuGMhKJh7bsWzITocORec3uCyPhV/9NYApXlg/Y8zy1dla6IDtX8s/35szIm0UKRS0rXhyn1scHFS35NeHCni1ULmhJGkYfHYPRRGtqJY+n2ei3ZW8mStkFhuQHULZxsm7MXoOojoF5C/H7PQNOuVVPfdm21wEhqgW7uecELDjEH/xLjp2BPoFINaF/ayjQEbd2SUAnCDZ6Qr8ojlqH/vLEyK6fONkXbTTXMwaHEIAocaU9r4ramWB8t2eUerkyPH8Y06Vb8yhDJBRShK/pCML9wUqVYf60wUFTJ7LeGAvYhjXiI9DhRBFOf2e0ZCcJ+oiIAg8CCy81pslnNIjUA7arDqUw4WwVbn64ZP8q7mDdwP5T8BET63pKkC3YSFWwI0r+6w5S51UhAjqraRvEG0XklOUVxT+8WnJQ9mz0Qx1ZW0ds0RIekjQzRpn1gROTtcmwb1DyQ3MCkNjKv6RqC8Cb59jeBKwgdj2+8hZWsmzAeCj2hVxQ3/r3vZq9zaappFd4qed91dmxG1vp/TjkTbLvel9tm8kZZasljj1b6ciC/FH259SmjNiVAvydVea4XkoeBxTwZBdKrbGJDTPRt8qF5AAtCHeNbYFHc76ZxDjLu48OweW0SQsyvlgW14W36ekKpY9Xf+LD3i4D+i+uYhKw0Pvhd2T3VjEml7eRSeCbdwRily1oiotKqA";
await ScanditSDK.configure(e,{engineLocation:"./libs/scandit-sdk/build/"});this.barcodePicker=await ScanditSDK.BarcodePicker.create(document.getElementById("application-project1-display-component---Initial--scandit-barcode-picker"),{scanSettings:new ScanditSDK.ScanSettings({enabledSymbologies:["code128","ean8","ean13","upca","upce"],codeDuplicateFilter:3e3}),playSoundOnScan:true,vibrateOnScan:true,scanningPaused:true,visible:false});this.barcodePicker.on("scan",e=>{var t=e.barcodes[0].data;var i=e.barcodes[0].location;var n=this._scanListModel.getData();var a={Result:t,product_sequence:n.length+1,bl:"X: "+i.bottomLeft.x+", Y: "+i.bottomLeft.y,br:"X: "+i.bottomRight.x+", Y: "+i.bottomRight.y,tl:"X: "+i.topLeft.x+", Y: "+i.topLeft.y,tr:"X: "+i.topRight.x+", Y: "+i.topRight.y};n.push(a);this._scanListModel.setData(n);var s=(i.topRight.x-i.topLeft.x)*512/1280;var r=(i.bottomLeft.y-i.topLeft.y)*288/720;var o=this._checkNewScannedProduct(t,i.topLeft.x*512/1280,i.topLeft.y*288/720,s,r);if(o){this._scannedProd.push({prod:t,product_sequence:this._scannedProd.length+1,x:i.topLeft.x*512/1280,y:i.topLeft.y*288/720,len:s,hei:r,pack_sequence:0,scannedOn:(new Date).getTime()})}if(this._scannedProd.length>2){console.log(this._scannedProd.length);this.barcodePicker.pauseScanning();this.barcodePicker.setVisible(false)}});this.barcodePicker.processVideoFrame(function(e){console.log(e)})},_checkNewScannedProduct:function(e,t,i,n,a){var s=this._scannedProd.findIndex(function(t){return t.prod==e});var r=true;if(s>-1){this._scannedProd.forEach(function(s){if(s.prod==e){if(Math.abs(s.x-t)<n&&Math.abs(s.y-i)<a){r=false}}})}return r},_drawPackSequence:function(){var e=document.getElementsByTagName("video")[0];var t=document.getElementById("application-project1-display-component---Initial--myCanvas1");var i=t.getContext("2d");i.drawImage(e,0,0,512,288);i.strokeStyle="green";var n=[];var a=1;for(let e=this._scannedProd.length-1;e>-1;e--){if(n.indexOf(this._scannedProd[e].prod)==-1){this._scannedProd[e].pack_sequence=a;i.strokeRect(this._scannedProd[e].x,this._scannedProd[e].y,this._scannedProd[e].len,this._scannedProd[e].hei);i.fillStyle="yellow";i.fillRect(this._scannedProd[e].x,this._scannedProd[e].y+this._scannedProd[e].hei+20*288/720,this._scannedProd[e].len*2,this._scannedProd[e].hei*1.5);i.fillStyle="black";i.font="30px Georgia";i.fillText(a,this._scannedProd[e].x+this._scannedProd[e].len,this._scannedProd[e].y+20*288/720+this._scannedProd[e].hei*1.75);a++}n.push(this._scannedProd[e].prod)}},onScanInputButton:function(){this.barcodePicker.setVisible(true);this.barcodePicker.resumeScanning();this._scannedProd=[];this._scanListModel.setData([])},onSelect:function(){this._drawPackSequence()},onCalculatePack:function(e){var t;if(e){var i=this._scanListModel.getData();for(var n=1;n<i.length;n++){t=t.append(i[n]["Result"]);var a={Productsequence:n,Product:i[n]["Result"]};var s={method:"POST",urlParameters:a,success:function(e){var t=e.PackResult},error:function(e){var t=JSON.parse(e.responseText);var i={message:t.error.message.value,severity:"error"};that.getMessageHandler().displayMessageBox(i,that.getResourceBundle());return}};oEvent.getSource().getModel().callFunction("/Calculate",s)}}},fontLoader:function(){(new THREE.FontLoader).load("./Fonts/helvetiker_bold.typeface.json",function(e){this.font=e}.bind(this))},initPosition:function(e,t,i,n,a,s){e.name=t;e.position.set(i,n,a);e.userData.treeNode={sid:s}},initThreejsModel:function(){a.addContentManagerResolver(this.threejsContentManagerResolver.bind(this));this.initPosition(this.root,"Root",0,0,0,"0");var e=new THREE.PerspectiveCamera(45,604/496,1,1e3);this.root.rotateY(-.2);this.root.rotateX(.1);var t=new THREE.AxesHelper(35);this.initPosition(t,"axe",-15,-12,-12,"1");this.root.add(t);this.axes=this.root.children[0];this.getView().byId("viewer").addContentResource(new n({source:this.root,sourceType:"THREE.Object3D",name:"Object3D"}))},threejsContentManagerResolver:function(e){var t=this;if(e.getSource()instanceof THREE.Object3D){return Promise.resolve({dimension:3,contentManagerClassName:"sap.ui.vk.threejs.ContentManager",settings:{loader:t.threejsObjectLoader}})}else{return Promise.reject()}},threejsObjectLoader:function(e,t){e.add(t.getSource());return Promise.resolve({node:e,contentResource:t})},onDisplay:function(e){this.axes.children=[];var t=this.byId("dimension").getValue();var i=o.isEmpty(t)?{}:JSON.parse(t);var n=o.isEmpty(i.d)?i:i.d.results;var a=this.byId("position").getValue();var s=o.isEmpty(a)?{}:JSON.parse(a);var r=o.isEmpty(s.d)?[]:s.d.results;var c=this.byId("length").getValue();var d=o.isEmpty(c)?n[0].laeng_pack:parseFloat(c);var h=this.byId("width").getValue();var l=o.isEmpty(h)?n[0].breit_pack:parseFloat(h);var u=this.byId("height").getValue();var p=o.isEmpty(u)?n[0].hoehe_pack:parseFloat(u);this.addHU(d,p,l);var v=[];if(o.isEmpty(a)){v=n}else{for(var g=0;g<n.length;g++){v.push(Object.assign(n[g],r[g]))}}this.addProducts(v)},findMaxLength:function(e,t,i){if(e>t){if(e>i){return e}else{return i}}else{if(t>i){return t}else{return i}}},addHU:function(e,t,i){var a,s,r;if(o.isEmpty(e)||o.isEmpty(t)||o.isEmpty(i)){a=30;s=30;r=30;this.ratio=600/30}else{a=parseFloat(e);s=parseFloat(t);r=parseFloat(i);var c=this.findMaxLength(a,s,r);this.ratio=c!==0?c/30:600/30;a=a/this.ratio;s=s/this.ratio;r=r/this.ratio}var d=new THREE.BoxGeometry(a,r,s);var h=new THREE.MeshBasicMaterial({color:16777215,opacity:.3,transparent:true,depthWrite:false});var l=new THREE.Mesh(d,h);this.initPosition(l,"hu",a/2,r/2,s/2,"2");this.axes.add(l);this.getView().byId("viewer").addContentResource(new n({source:this.root,sourceType:"THREE.Object3D",name:"Object3D"}))},addProducts:function(e){e.forEach(function(e){this.addProduct(e)}.bind(this));this.addSequence(e)},addProduct:function(e){this.adjustOrienation(e);var t=e.laeng/this.ratio;var i=e.breit/this.ratio;var a=e.hoehe/this.ratio;var s=new THREE.BoxGeometry(t,a,i);var r=new THREE.MeshBasicMaterial({color:4107263,opacity:.35,transparent:true,side:THREE.DoubleSide});var o=new THREE.Mesh(s,r);this.initPosition(o,"product",e.xpos/this.ratio+t/2,e.zpos/this.ratio+a/2,e.ypos/this.ratio+i/2,"S"+e.PacSequence);this.axes.add(o);this.getView().byId("viewer").addContentResource(new n({source:this.root,sourceType:"THREE.Object3D",name:"Object3D"}))},adjustOrienation:function(e){var t;switch(e.orientation){case 2:t=e.laeng;e.laeng=e.breit;e.breit=t;return e;case 3:t=e.breit;e.breit=e.hoehe;e.hoehe=t;return e;case 4:t=e.laeng;e.laeng=e.hoehe;e.hoehe=e.breit;e.breit=t;return e;case 5:t=e.laeng;e.laeng=e.hoehe;e.hoehe=t;return e;case 6:t=e.laeng;e.laeng=e.breit;e.breit=e.hoehe;e.hoehe=t;return e;default:return e}},addSequence:function(e){var t;var i;var a;var s;var r;var o;e.forEach(function(e){t=e.laeng/this.ratio;i=e.breit/this.ratio;a=e.hoehe/this.ratio;s=new THREE.TextGeometry(e.pac_sequence.toString(),{size:2.2,height:.2,weight:"normal",font:this.font,style:"normal",bevelThickness:1,bevelSize:1,curveSegments:60,bevelEnabled:false});r=new THREE.MeshPhongMaterial({color:16711680,specular:39168,shininess:30,shading:THREE.FlatShading});o=new THREE.Mesh(s,r);this.initPosition(o,"sequence",e.xpos/this.ratio+t/2,e.zpos/this.ratio+a/2,e.ypos/this.ratio+i/2,"Se"+e.pac_sequence);this.axes.add(o)}.bind(this));this.getView().byId("viewer").addContentResource(new n({source:this.root,sourceType:"THREE.Object3D",name:"Object3D"}))}})});